metadata:
  title: ディスク使用量の増加トレンド予測 - 設計書
  feature: disk-trend-prediction
  status: implemented
  created: 2025-11-23
  updated: 2025-11-25
correctness-properties:
- id: P1
  title: 日次平均計算の正確性
  type: invariant
  description: '*任意の*7日分のディスク使用率データに対して、日次平均を計算した結果は、各日のデータの算術平均と一致しなければならない'
  validates:
  - AC-001
  test-strategy: property-based
- id: P2
  title: 欠損データの処理
  type: invariant
  description: '*任意の*欠損を含むディスク使用率データに対して、予測は利用可能なデータのみを使用して実行され、欠損データは無視されなければならない'
  validates:
  - AC-001
  test-strategy: property-based
- id: P3
  title: 線形回帰の正確性
  type: invariant
  description: '*任意の*2点以上のデータセットに対して、最小二乗法で計算された傾きと切片は、数学的に正しい値でなければならない'
  validates:
  - AC-002
  test-strategy: property-based
- id: P4
  title: 90%到達予測の正確性
  type: invariant
  description: '*任意の*増加傾向（傾き > 0）のデータに対して、90%到達予測日は `(90 - current_usage) / slope`
    の計算式で算出された日数と一致しなければならない'
  validates:
  - AC-002
  test-strategy: property-based
- id: P5
  title: 前日比計算の正確性
  type: invariant
  description: '*任意の*2日以上のデータに対して、前日比は最新日と前日のディスク使用率の差分と一致しなければならない'
  validates:
  - AC-003
  test-strategy: property-based
- id: P6
  title: 急激な変化検出の正確性
  type: invariant
  description: '*任意の*前日比データに対して、10%以上の増加の場合は`is_rapid=True`、10%未満の場合は`is_rapid=False`でなければならない'
  validates:
  - AC-003
  test-strategy: property-based
- id: P7
  title: 予測メッセージの完全性
  type: invariant
  description: '*任意の*予測結果に対して、生成されるメッセージは以下の要素を含まなければならない：増加トレンドの説明、90%到達予測日（存在する場合）、急激な変化の警告（検出された場合）、推奨アクション（警告がある場合）'
  validates:
  - AC-004
  test-strategy: property-based
- id: P8
  title: 警告の優先度順表示
  type: invariant
  description: '*任意の*複数の警告を含む予測結果に対して、メッセージは優先度の高い順（急激な変化 > 90%到達予測 > 通常の増加）に表示されなければならない'
  validates:
  - AC-005
  test-strategy: property-based
- id: P9
  title: 週次レポートへの統合
  type: invariant
  description: '*任意の*週次レポートについて、ディスク使用量予測結果が正しくフォーマットされてレポートに含まれること'
  validates:
  - AC-006
  test-strategy: integration
- id: P10
  title: テストによる品質保証
  type: invariant
  description: '*任意の*実装について、プロパティテスト、統合テスト、ユニットテストが全てパスし、カバレッジ90%以上を維持すること'
  validates:
  - AC-007
  test-strategy: property-based

resilience:
  circuit-breaker:
    considered: true
    decision: "not-adopted"
    rationale: |
      ディスク使用量予測機能は短命なCLI/バッチツールとして実行される。
      継続的な接続維持や大量トラフィックを扱わないため、
      サーキットブレイカー機構は不要。
      
      サーキットブレイカーが必要となるケースは、Komonの呼び出し元
      （ジョブスケジューラ、監視システム等）で実装する方が
      責務の分離として適切。
    delegated-to: "upstream-system"
    future-notes: |
      将来Komonがデーモンモードを持つ場合は、サーキットブレイカー設計を
      再検討する必要がある。
    
  notification-throttling:
    considered: true
    decision: "adopted"
    rationale: |
      ディスク使用量の急激な変化が連続して検出される場合、
      通知スパムを防ぐため一時的に通知を抑制する。
      
      ただし、v1.16.0では基本実装のみで、将来のバージョンで
      通知抑制機能を追加する。
    implementation:
      - "同じ警告が10回/3分以上 → 3分間通知停止（将来実装）"
      - "停止中も内部ログには記録"
      - "停止解除時に「通知を再開しました」メッセージ"
      
  baseline-reset:
    considered: true
    decision: "not-applicable"
    rationale: |
      ディスク使用量予測機能はbaselineを使用しないため、
      baseline自動リセット機能は不要。
      
      この機能は、ログ異常検知など他のKomon機能で検討すべき。
    implementation: []
    
  other-considerations:
    - consideration: "データ欠損時のフォールバック"
      decision: "adopted"
      rationale: |
        7日分のデータが不足している場合でも、利用可能なデータで
        予測を実行する。最低2日分のデータがあれば予測可能。
    - consideration: "異常値の除外"
      decision: "not-adopted"
      rationale: |
        v1.16.0では異常値の自動除外は実装しない。
        ユーザーが手動でデータを確認・修正することを想定。
        将来のバージョンで検討。
