---
title: 段階的通知メッセージ - 要件定義
feature: progressive-notification
status: in-progress
created: 2025-11-26
updated: 2025-11-26
---

# 段階的通知メッセージ - 要件定義書

## 概要

この機能は、既存の通知履歴機能（v1.11.0）を活用して、同一問題の繰り返し回数に応じて通知メッセージを段階的に変化させる機能です。これにより、問題の緊急度を適切に伝え、「通知疲れ」を防ぎ、ユーザーの注意を適切に引きつけることを目的としています。

## 背景

v1.10.1で通知メッセージの口調改善が完了し、v1.11.0で通知履歴機能が実装されました。現在、Komonは閾値を超えた際に通知を送信しますが、同じ問題が繰り返し発生しても常に同じメッセージを送信します。

これにより、以下の課題があります：

1. **緊急度が伝わらない**: 初回の通知も3回目の通知も同じ表現なので、問題の深刻さが伝わりにくい
2. **通知疲れ**: 同じメッセージが繰り返されると「またか」となり、重要な通知を見逃すリスクがある
3. **コンテキストの欠如**: 「これは初めての警告なのか、それとも継続中の問題なのか」が分からない

## 目的

通知履歴を活用して、同一問題の繰り返し回数に応じて段階的にメッセージを変化させることで、問題の緊急度を適切に伝え、ユーザーの注意を適切に引きつけます。

## スコープ

### 対象

- CPU使用率の閾値超過通知
- メモリ使用率の閾値超過通知
- ディスク使用率の閾値超過通知

### 対象外

- ログ急増通知（別の通知ロジックのため、将来的に対応）
- 週次レポート（定期レポートは段階的メッセージの対象外）

## 用語集

- **段階的メッセージ**: 通知回数に応じて変化するメッセージテンプレート
- **通知回数**: 指定された時間窓内の同一メトリクスタイプの通知発生回数
- **時間窓**: 通知回数をカウントする期間（デフォルト: 24時間）
- **メトリクスタイプ**: CPU、メモリ、ディスクなどの監視対象の種類
- **通知履歴**: `data/notifications/queue.json`に保存された過去の通知記録

## 受入基準

### [AC-001] 通知履歴の分析

**ユーザーストーリー:** システム管理者として、同じ問題が繰り返し発生しているかを把握したいので、通知回数を自動的に判定する機能が必要です。

#### 受入条件

1. **WHEN** システムが閾値超過を検知したとき、**THEN** システムは過去24時間以内の同一メトリクスタイプの通知回数を判定すること
2. **WHEN** 通知回数を判定するとき、**THEN** システムは同一メトリクスタイプ（cpu, mem, disk）のみをカウントすること
3. **WHEN** 通知回数を判定するとき、**THEN** システムは時間窓外（24時間より前）の通知を除外すること
4. **WHEN** 異なるメトリクスタイプの通知があるとき、**THEN** システムは各メトリクスタイプを独立してカウントすること
5. **WHEN** 通知履歴が存在しないとき、**THEN** システムは通知回数を0として扱うこと

### [AC-002] 段階的メッセージの生成

**ユーザーストーリー:** システム管理者として、問題の緊急度を把握したいので、通知回数に応じて異なるメッセージが表示される機能が必要です。

#### 受入条件

1. **WHEN** 通知回数が1回目のとき、**THEN** システムは「ちょっと気になることがあります」という穏やかな表現のメッセージを生成すること
2. **WHEN** 通知回数が2回目のとき、**THEN** システムは「まだ続いてますね」という継続を示唆するメッセージを生成すること
3. **WHEN** 通知回数が3回目以降のとき、**THEN** システムは「そろそろ見た方がいいかも」という行動を促すメッセージを生成すること
4. **WHEN** メッセージを生成するとき、**THEN** システムはメトリクス名、値、単位を含めること
5. **WHEN** カスタムテンプレートが設定されているとき、**THEN** システムはカスタムテンプレートを使用すること

### [AC-003] 既存機能との統合

**ユーザーストーリー:** 開発者として、既存の通知機能に影響を与えずに段階的メッセージを追加したいので、既存コードとの統合が適切に行われる必要があります。

#### 受入条件

1. **WHEN** 段階的メッセージが生成されたとき、**THEN** システムはSlack通知で段階的メッセージを送信すること
2. **WHEN** 段階的メッセージが生成されたとき、**THEN** システムはメール通知で段階的メッセージを送信すること
3. **WHEN** 段階的メッセージが生成されたとき、**THEN** システムは通知履歴に段階的メッセージを保存すること
4. **WHEN** 既存のテストを実行するとき、**THEN** 全てのテストは変更なしでパスすること
5. **WHEN** 段階的メッセージ機能が無効化されているとき、**THEN** システムは従来のメッセージを使用すること

### [AC-004] 時間窓のリセット

**ユーザーストーリー:** システム管理者として、問題が解決した後は通知回数がリセットされてほしいので、時間窓による自動リセット機能が必要です。

#### 受入条件

1. **WHEN** 24時間以上通知がなかったとき、**THEN** システムは次の通知を1回目として扱うこと
2. **WHEN** 時間窓内に複数の通知があるとき、**THEN** システムは正確な回数をカウントすること
3. **WHEN** 異なるメトリクスタイプの通知があるとき、**THEN** システムは各メトリクスタイプの時間窓を独立して管理すること

### [AC-005] エラーハンドリング

**ユーザーストーリー:** システム管理者として、エラーが発生しても通知が送信されてほしいので、適切なエラーハンドリングが必要です。

#### 受入条件

1. **WHEN** 通知履歴の読み込みに失敗したとき、**THEN** システムはデフォルトメッセージ（1回目）で通知を送信すること
2. **WHEN** 履歴ファイルが存在しないとき、**THEN** システムは通知回数を0として扱い、通知を継続すること
3. **WHEN** 履歴ファイルが破損しているとき、**THEN** システムは警告をログに記録し、通知を継続すること
4. **WHEN** タイムスタンプのパースに失敗したとき、**THEN** システムは該当エントリをスキップし、他のエントリを処理すること

## 非機能要件

### パフォーマンス
- 通知回数の判定処理は100ms以内に完了すること
- 既存の通知送信処理に遅延を与えないこと

### 保守性
- 段階的メッセージのテンプレートは設定ファイルで変更可能であること
- 時間窓（24時間）は設定ファイルで変更可能であること

### テスト容易性
- 通知回数の判定ロジックは独立してテスト可能であること
- モックを使用して各段階のメッセージをテスト可能であること

## 制約

- 既存の通知履歴機能（v1.11.0）に依存する
- 通知履歴ファイル（`data/notifications/queue.json`）の形式は変更しない
- 既存の通知機能に破壊的変更を加えない

## 用語集

- **メトリクスタイプ**: CPU、メモリ、ディスクなどの監視対象の種類
- **時間窓**: 通知回数をカウントする期間（デフォルト: 24時間）
- **段階的メッセージ**: 通知回数に応じて変化するメッセージテンプレート
- **通知履歴**: `data/notifications/queue.json`に保存された過去の通知記録
