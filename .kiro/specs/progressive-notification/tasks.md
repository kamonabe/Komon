---
title: 段階的通知メッセージ - 実装タスク
feature: progressive-notification
status: completed
created: 2025-11-26
updated: 2025-11-26
---

# 段階的通知メッセージ - 実装タスク

## タスクチェックリスト

- [x] 1. 段階的メッセージモジュールの作成
  - `src/komon/progressive_message.py`を作成
  - `get_notification_count()`関数を実装
  - `generate_progressive_message()`関数を実装
  - デフォルトテンプレートを定義
  - _要件: AC-001.1, AC-001.2, AC-001.3, AC-002.1, AC-002.2, AC-002.3, AC-002.4_

- [x] 1.1 通知回数の正確性のプロパティテストを作成
  - **プロパティ1: 通知回数の正確性**
  - **検証対象: 要件 AC-001.1, AC-001.2, AC-001.3**

- [x] 1.2 段階的メッセージの一貫性のプロパティテストを作成
  - **プロパティ2: 段階的メッセージの一貫性**
  - **検証対象: 要件 AC-002.1, AC-002.2, AC-002.3**

- [x] 1.3 時間窓のリセットのプロパティテストを作成
  - **プロパティ3: 時間窓のリセット**
  - **検証対象: 要件 AC-004.1, AC-004.2**

- [x] 1.4 メトリクスタイプの独立性のプロパティテストを作成
  - **プロパティ4: メトリクスタイプの独立性**
  - **検証対象: 要件 AC-001.4, AC-004.3**

- [x] 1.5 エラー時のデフォルト動作のプロパティテストを作成
  - **プロパティ5: エラー時のデフォルト動作**
  - **検証対象: 要件 AC-005.1, AC-005.2, AC-005.3**

- [x] 2. Analyzerモジュールの修正
  - `src/komon/analyzer.py`の`analyze_usage()`を修正
  - 閾値超過時に通知回数を取得
  - 段階的メッセージを生成
  - CPU、メモリ、ディスクの3つに対応
  - _要件: AC-003.1, AC-003.2, AC-003.3_

- [x] 2.1 Analyzer修正のユニットテストを作成
  - 各段階のメッセージ生成をテスト
  - 既存の閾値判定ロジックが変更されていないことをテスト
  - _要件: AC-003.4_

- [x] 3. 設定ファイルの拡張
  - `config/settings.yml.sample`に`progressive_notification`セクションを追加
  - デフォルト値とコメントを記載
  - _要件: AC-002.5, AC-003.5_

- [x] 4. 統合テストの追加
  - シナリオ1: 初回通知（1回目のメッセージ）
  - シナリオ2: 2回目通知（2回目のメッセージ）
  - シナリオ3: 3回目以降通知（3回目のメッセージ）
  - シナリオ4: 時間窓リセット（24時間後に1回目）
  - シナリオ5: 異なるメトリクス（独立カウント）
  - _要件: AC-003.1, AC-003.2, AC-003.3, AC-004.1, AC-004.3_

- [x] 5. チェックポイント - 全テストがパスすることを確認
  - 全テストがパスすることを確認し、疑問があればユーザーに質問する

- [x] 6. ドキュメントの更新
  - README.mdに段階的通知メッセージの説明を追加
  - CHANGELOG.mdにv1.17.0の変更内容を記録
  - _要件: 全て_

## 詳細タスク

### 1. 段階的メッセージモジュールの作成

**ファイル**: `src/komon/progressive_message.py`

**実装内容**:
- `get_notification_count()`: 通知回数の取得
- `generate_progressive_message()`: 段階的メッセージの生成
- `DEFAULT_TEMPLATES`: デフォルトテンプレート定義

**要件**: AC-001, AC-002

**完了条件**:
- 通知履歴から24時間以内の同一メトリクスタイプをカウントできる
- 通知回数（1, 2, 3以上）に応じたメッセージが生成される
- エラー時は0を返す（デフォルトメッセージ）

### 2. Analyzerモジュールの修正

**ファイル**: `src/komon/analyzer.py`

**実装内容**:
- `analyze_usage()`関数を修正
- 閾値超過時に`get_notification_count()`を呼び出し
- `generate_progressive_message()`でメッセージを生成
- CPU、メモリ、ディスクの3つに対応

**要件**: AC-003

**完了条件**:
- 既存の閾値判定ロジックは変更なし
- 段階的メッセージが正しく生成される
- 既存テストが全てパス

### 3. 設定ファイルの拡張

**ファイル**: `config/settings.yml.sample`

**実装内容**:
- `progressive_notification`セクションを追加
- `enabled`, `time_window_hours`, `templates`の設定項目
- デフォルト値とコメントを記載

**要件**: AC-002

**完了条件**:
- 設定ファイルサンプルが更新される
- 既存の設定項目は変更なし

### 4. プロパティベーステストの追加

**ファイル**: `tests/test_progressive_message_properties.py`

**実装内容**:
- プロパティ1: 通知回数の正確性
- プロパティ2: 段階的メッセージの一貫性
- プロパティ3: 時間窓のリセット
- プロパティ4: メトリクスタイプの独立性
- プロパティ5: エラー時のデフォルト動作

**要件**: 全AC

**完了条件**:
- 5つのプロパティテストが実装される
- 各テストが100回以上実行される
- 全テストがパス

### 5. ユニットテストの追加

**ファイル**: `tests/test_progressive_message.py`

**実装内容**:
- `get_notification_count()`のテスト
  - 通知なし（0件）
  - 通知あり（1件、2件、3件以上）
  - 時間窓外の通知は除外
  - 異なるメトリクスタイプは除外
- `generate_progressive_message()`のテスト
  - 各段階のメッセージ生成
  - カスタムテンプレート
  - エラーハンドリング

**要件**: 全AC

**完了条件**:
- 10件以上のユニットテストが実装される
- 全テストがパス
- カバレッジ95%以上

### 6. 統合テストの追加

**ファイル**: `tests/test_progressive_notification_integration.py`

**実装内容**:
- シナリオ1: 初回通知（1回目のメッセージ）
- シナリオ2: 2回目通知（2回目のメッセージ）
- シナリオ3: 3回目以降通知（3回目のメッセージ）
- シナリオ4: 時間窓リセット（24時間後に1回目）
- シナリオ5: 異なるメトリクス（独立カウント）

**要件**: AC-003, AC-004

**完了条件**:
- 5つの統合テストが実装される
- 全テストがパス
- 既存の統合テストも全てパス

### 7. ドキュメント更新

**ファイル**: `README.md`, `docs/CHANGELOG.md`

**実装内容**:
- README.md: 段階的通知メッセージの説明を追加
- CHANGELOG.md: v1.17.0の変更内容を記録

**要件**: 全AC

**完了条件**:
- ドキュメントが更新される
- 使い方の例が記載される

### 8. 全テストの実行とカバレッジ確認

**コマンド**: `bash run_coverage.sh`

**実装内容**:
- 全テストを実行
- カバレッジレポートを確認
- README.mdのバッジを更新（必要に応じて）

**要件**: 全AC

**完了条件**:
- 全テストがパス
- カバレッジ95%以上を維持
- README.mdのバッジが最新

## 実装順序

```
1. progressive_message.py の作成
   ↓
2. analyzer.py の修正
   ↓
3. settings.yml.sample の更新
   ↓
4. ユニットテストの追加
   ↓
5. プロパティベーステストの追加
   ↓
6. 統合テストの追加
   ↓
7. 全テスト実行
   ↓
8. ドキュメント更新
```

## 完了条件

- [ ] 全タスクが完了している
- [ ] 全テストがパスしている（238テスト以上）
- [ ] カバレッジが95%以上を維持している
- [ ] README.mdとCHANGELOG.mdが更新されている
- [ ] 既存機能に影響がない
- [ ] 段階的メッセージが正しく動作する
