---
title: 段階的閾値通知 - 設計書
feature: progressive-threshold
status: implemented
created: 2025-11-23
updated: 2025-11-25
---

# 段階的閾値通知 - 設計書

## 概要

3段階の閾値通知システムを実装し、警告（70%）、警戒（80%）、緊急（90%）の各レベルで適切なメッセージを生成します。既存の単一閾値設定との後方互換性を維持します。

設計の主要な方針：
- 3段階閾値設定のサポート（警告/警戒/緊急）
- 既存の単一閾値設定との後方互換性
- レベル別メッセージテンプレートシステム
- 設定の検証と正規化

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    settings.yml                              │
│              (3段階閾値設定)                                  │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│           src/komon/settings_validator.py                   │
│              (設定検証と正規化)                               │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              src/komon/analyzer.py                          │
│         (閾値レベル判定とメッセージ生成)                      │
└─────────────────────────────────────────────────────────────┘
```

## コンポーネントとインターフェース

### 1. 設定バリデータ (`src/komon/settings_validator.py`)

**責務**:
- 3段階閾値設定の検証
- 後方互換性の確保
- 閾値の順序検証（警告 < 警戒 < 緊急）

**主要関数**:

```python
def validate_threshold_config(config: dict) -> dict:
    """
    閾値設定を検証し、正規化する。
    従来の単一値形式と新しい3段階形式の両方をサポート。
    
    Args:
        config: 閾値設定辞書
        
    Returns:
        正規化された3段階形式の設定
        
    Raises:
        ValidationError: 設定が無効な場合
    """
    pass
```

### 2. アナライザー (`src/komon/analyzer.py`)

**責務**:
- 3段階判定ロジックの実装
- 各メトリクスの閾値レベル判定
- レベルに応じたメッセージ生成

**主要関数**:

```python
def determine_threshold_level(value: float, thresholds: dict) -> ThresholdLevel:
    """
    値と3段階閾値に基づいて閾値レベルを判定する。
    
    Args:
        value: メトリクス値
        thresholds: 3段階閾値設定
        
    Returns:
        ThresholdLevel: 判定されたレベル
    """
    pass
```

### 3. 設定ファイル (`settings.yml`)

**責務**:
- 従来形式と新形式の両方をサポート
- 3段階閾値のデフォルト値定義

## データ構造

### 3段階閾値設定
```yaml
thresholds:
  cpu:
    warning: 70
    alert: 80
    critical: 90
  memory:
    warning: 70
    alert: 80
    critical: 90
  disk:
    warning: 70
    alert: 80
    critical: 90
```

### 従来の単一閾値設定（後方互換性あり）
```yaml
thresholds:
  cpu: 80
  memory: 80
  disk: 80
```

### 閾値レベル列挙型
```python
class ThresholdLevel(Enum):
    NORMAL = "normal"      # 正常
    WARNING = "warning"    # 警告
    ALERT = "alert"        # 警戒
    CRITICAL = "critical"  # 緊急
```

## 正確性プロパティ

*プロパティとは、システムの全ての有効な実行において真であるべき特性や振る舞いのことです。本質的には、システムが何をすべきかについての形式的な記述です。プロパティは、人間が読める仕様と機械で検証可能な正確性保証との橋渡しをします。*

### プロパティ1: 閾値の順序性
*任意の*メトリクスタイプについて、警告閾値 < 警戒閾値 < 緊急閾値でなければならない
**検証対象: 要件 AC-006**

### プロパティ2: レベル判定の正確性
*任意の*値Vと閾値(W, A, C)について、V < W の場合はNORMAL、W ≤ V < A の場合はWARNING、A ≤ V < C の場合はALERT、C ≤ V の場合はCRITICALと判定されなければならない
**検証対象: 要件 AC-003**

### プロパティ3: 後方互換性
*任意の*従来の単一閾値Tについて、3段階(T, T, T)と等価でなければならない
**検証対象: 要件 AC-002**

### プロパティ4: メッセージの一貫性
*任意の*閾値レベルについて、正確に1つの絵文字とメッセージテンプレートにマッピングされなければならない
**検証対象: 要件 AC-004**

### プロパティ5: 設定の検証
*任意の*無効な閾値設定（例: 警告 > 警戒）について、ValidationErrorを発生させなければならない
**検証対象: 要件 AC-006**

## テスト戦略

### プロパティベーステスト

Pythonの`hypothesis`ライブラリを使用します。

**設定:**
- 最小実行回数: 100回
- タイムアウト: テストごとに30秒

**テスト対象:**
- プロパティ1: 閾値の順序性
- プロパティ2: レベル判定の正確性
- プロパティ3: 後方互換性
- プロパティ4: メッセージの一貫性
- プロパティ5: 設定の検証

**テストファイル:** `tests/test_settings_validator.py`

### ユニットテスト

Pythonの標準`unittest`フレームワークを使用します。

**テスト対象:**
- 3段階閾値検知
- メッセージテンプレート選択
- 絵文字割り当て
- 無効な設定処理
- エッジケース（閾値ちょうどの値、負の値）

**テストファイル:** `tests/test_analyzer.py`

### 統合テスト

**テストシナリオ:**
1. 3段階レベルでのエンドツーエンド閾値検知
2. 適切なメッセージでの通知生成
3. 設定ファイル読み込みと検証
4. 従来設定との後方互換性

**テストファイル:** `tests/test_integration_threshold.py`

### 手動テスト

**確認項目:**
1. 各閾値レベルで適切なメッセージが表示されるか
2. 従来の設定ファイルが正しく動作するか
3. 無効な設定でエラーが発生するか
4. エスカレーション検知が機能するか

## 実装詳細

### 1. 設定バリデータの拡張

3段階閾値の検証関数を追加:

```python
def validate_threshold_config(config: dict) -> dict:
    """
    閾値設定を検証し、正規化する。
    従来の単一値形式と新しい3段階形式の両方をサポート。
    
    正規化された3段階形式を返す。
    """
    # 実装詳細はtasks.mdを参照
```

### 2. アナライザーの拡張

閾値レベル判定を追加:

```python
def determine_threshold_level(value: float, thresholds: dict) -> ThresholdLevel:
    """
    値と3段階閾値に基づいて閾値レベルを判定する。
    """
    # 実装詳細はtasks.mdを参照
```

### 3. メッセージテンプレートシステム

レベル別テンプレートの定義:

```python
MESSAGE_TEMPLATES = {
    ThresholdLevel.WARNING: {
        "emoji": "💛",
        "prefix": "そろそろ気にかけておいた方がいいかも",
    },
    ThresholdLevel.ALERT: {
        "emoji": "🧡",
        "prefix": "ちょっと気になる水準です",
    },
    ThresholdLevel.CRITICAL: {
        "emoji": "❤️",
        "prefix": "かなり逼迫しています！",
    },
}
```

## テスト戦略

### プロパティベーステスト（hypothesis）
1. 閾値順序の検証
2. すべての値範囲に対するレベル判定
3. 設定の正規化（従来形式 → 3段階形式）

### ユニットテスト
1. 有効な3段階設定の読み込み
2. 従来設定の後方互換性
3. 無効な設定の拒否
4. メッセージテンプレートの選択
5. 絵文字の割り当て

### 統合テスト
1. 3段階レベルでのエンドツーエンド閾値検知
2. 適切なメッセージでの通知生成
3. 設定ファイルの読み込みと検証

## 移行パス

### フェーズ1: サポート追加（後方互換性あり）
- 3段階閾値サポートの実装
- 従来の単一閾値サポートの維持
- 未設定の場合は従来の動作をデフォルトとする

### フェーズ2: ドキュメント化
- README.mdに3段階設定の例を追加
- 既存ユーザー向けの移行ガイドを追加

### フェーズ3: 非推奨化（将来）
- 従来の単一閾値を非推奨としてマーク
- 移行ツールの提供（オプション）

## デフォルト値

```yaml
# デフォルトの3段階閾値
thresholds:
  cpu:
    warning: 70
    alert: 80
    critical: 90
  memory:
    warning: 70
    alert: 80
    critical: 90
  disk:
    warning: 70
    alert: 80
    critical: 90
```

## エッジケース

1. **閾値ちょうどの値**: レベル判定には >= を使用
2. **閾値レベルの欠落**: 従来の単一閾値にフォールバック
3. **無効な順序**: 起動時にValidationErrorを発生
4. **負の値**: NORMALレベルとして扱う
5. **100超の値**: 閾値ロジックを適用（CPUバーストシナリオ用）

## パフォーマンス考慮事項

- 閾値判定: O(1)の比較演算
- 設定検証: 起動時に1回のみ
- 追加のメモリオーバーヘッドなし（既存構造を再利用）

## セキュリティ考慮事項

- 閾値が数値で妥当な範囲（0-200）内であることを検証
- 適切なYAMLパースによる設定インジェクションの防止
- 監査証跡のための設定検証エラーのログ記録
