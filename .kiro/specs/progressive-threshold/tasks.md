---
feature: Progressive Threshold Notification
status: in-progress
created: 2025-11-23
updated: 2025-11-23
---

# 実装タスク: 段階的閾値通知

## タスク分解

### [x] 1. 設定バリデータモジュールの作成
**ファイル**: `src/komon/settings_validator.py`
- `ThresholdLevel` 列挙型の定義
- `validate_threshold_config()` 関数の実装
- 従来形式と3段階形式の両方をサポート
- 閾値の順序検証（警告 < 警戒 < 緊急）
- 包括的なエラーメッセージの追加

### [x] 2. settings.ymlに3段階設定を追加
**ファイル**: `settings.yml.sample` および `settings.yml`
- 3段階閾値設定の例を追加
- 従来形式のサポートをドキュメント化
- 各レベルを説明するコメントを追加
- デフォルト値を設定（70/80/90）

### [x] 3. アナライザーに3段階ロジックを追加
**ファイル**: `src/komon/analyzer.py`
- 設定バリデータをインポート
- `determine_threshold_level()` 関数の実装
- `analyze_metrics()` を3段階ロジックに更新
- 従来の閾値との後方互換性を維持
- レベル別メッセージ生成を追加

### [x] 4. メッセージテンプレートシステムの作成
**ファイル**: `src/komon/analyzer.py`（または新規 `message_templates.py`）
- `MESSAGE_TEMPLATES` 辞書の定義
- 各レベルを絵文字とメッセージプレフィックスにマッピング
- メッセージフォーマット関数の実装
- 日本語メッセージテンプレートのサポート

### [x] 5. プロパティベーステストの作成
**ファイル**: `tests/test_settings_validator.py`
- 閾値順序検証のテスト（PROP-001）
- すべての範囲に対するレベル判定のテスト（PROP-002）
- 後方互換性のテスト（PROP-003）
- 設定正規化のテスト
- hypothesisを使用したプロパティベーステスト

### [x] 6. ユニットテストの作成
**ファイル**: `tests/test_analyzer.py`（既存を拡張）
- 3段階閾値検知のテスト
- メッセージテンプレート選択のテスト
- 絵文字割り当てのテスト
- 無効な設定処理のテスト
- エッジケースのテスト（閾値ちょうどの値、負の値）

### [x] 7. 統合テストの作成
**ファイル**: `tests/test_integration_threshold.py`
- 3段階レベルでのエンドツーエンド閾値検知のテスト
- 適切なメッセージでの通知生成のテスト
- 設定ファイル読み込みのテスト
- 従来設定との後方互換性のテスト

### [x] 8. ドキュメントの更新
**ファイル**: `README.md`, `docs/OPERATIONS.md`
- 3段階閾値設定セクションの追加
- 設定例の提供
- 各閾値レベルの意味を説明
- 従来形式からの移行ガイドを追加

### [x] 9. CHANGELOGの更新
**ファイル**: `docs/CHANGELOG.md`
- 新しい3段階閾値機能をドキュメント化
- 後方互換性について記載
- 設定変更をリスト化

### [x] 10. 全テストスイートの実行
- すべてのテストを実行: `python -m pytest tests/ -v`
- カバレッジを確認: `bash run_coverage.sh`
- 160テストがすべてパス
- カバレッジ93%を維持

## 受入基準チェックリスト

- [x] AC-001: 3段階閾値設定がサポートされている
- [x] AC-002: 後方互換性が維持されている
- [x] AC-003: 3段階判定ロジックが実装されている
- [x] AC-004: レベル別メッセージテンプレートが動作している
- [x] AC-005: エスカレーション検知が実装されている
- [x] AC-006: 設定検証が動作している

## テストチェックリスト

- [x] プロパティベーステストがパスする（hypothesis）
- [x] ユニットテストがパスする（すべての閾値レベル）
- [x] 統合テストがパスする（エンドツーエンド）
- [x] 後方互換性が検証されている
- [x] エッジケースがカバーされている
- [x] カバレッジが93%

## ドキュメントチェックリスト

- [x] README.mdが更新されている
- [ ] OPERATIONS.mdが更新されている（必要に応じて）
- [x] CHANGELOG.mdが更新されている
- [x] 設定例が追加されている
- [x] 移行ガイドが提供されている

## 完了の定義

- [x] すべてのタスクが完了している
- [x] すべてのテストがパスしている
- [x] ドキュメントが更新されている
- [x] 後方互換性が検証されている
- [x] mainへのマージ準備が完了している
