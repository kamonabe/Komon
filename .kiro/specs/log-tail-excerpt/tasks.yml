metadata:
  title: ログ急増時の末尾抜粋表示 - 実装タスク
  feature: log-tail-excerpt
  task-id: TASK-007
  status: completed
  created: 2025-11-30
  updated: 2025-11-30
  version: "1.0.0"
  last_validated: null
  validation_passed: null

tasks:
  - id: T1
    title: ログ末尾抽出モジュールの作成
    status: done
    priority: high
    estimated-hours: 1.0
    depends-on: []
    validates:
      - AC-001
      - AC-004
      - AC-005
    description: |
      - ファイル: src/komon/log_tail_extractor.py
      - 関数: extract_log_tail(log_path, lines, max_line_length)
      - ファイルを末尾から効率的に読み込む
      - 指定行数を抽出
      - 長い行を切り詰める
      - エラーハンドリング（FileNotFoundError, PermissionError）
  
  - id: T2
    title: 通知メッセージのフォーマット関数を追加
    status: done
    priority: high
    estimated-hours: 0.5
    depends-on:
      - T1
    validates:
      - AC-002
    description: |
      - ファイル: scripts/main_log_monitor.py
      - 関数: format_alert_with_tail(alert, log_path, tail_lines)
      - 警告メッセージに末尾抜粋を追加
      - コードブロック形式で整形
      - ログファイルパスを明記
  
  - id: T3
    title: main_log_monitor.pyの統合
    status: done
    priority: high
    estimated-hours: 0.5
    depends-on:
      - T1
      - T2
    validates:
      - AC-001
      - AC-002
      - AC-003
      - AC-005
    description: |
      - ファイル: scripts/main_log_monitor.py
      - 設定からtail_linesを読み込む
      - ログ急増検出時に末尾を抽出
      - フォーマット関数を呼び出し
      - エラー時も通知を継続
  
  - id: T4
    title: 設定ファイルの拡張
    status: done
    priority: medium
    estimated-hours: 0.2
    depends-on: []
    validates:
      - AC-003
    description: |
      - ファイル: config/settings.yml.sample
      - log_analysis.tail_lines を追加（デフォルト: 10）
      - log_analysis.max_line_length を追加（デフォルト: 500）
      - コメントで説明を追加
  
  - id: T5
    title: プロパティテストの作成
    status: done
    priority: high
    estimated-hours: 0.5
    depends-on:
      - T1
    validates:
      - AC-001
      - AC-004
    description: |
      - ファイル: tests/test_log_tail_extractor_properties.py
      - Property 1: 行数カウントの正確性
      - Property 2: 末尾からの順序性
      - Property 3: 長い行の切り詰め
  
  - id: T6
    title: 統合テストの作成
    status: done
    priority: high
    estimated-hours: 0.5
    depends-on:
      - T1
      - T2
      - T3
    validates:
      - AC-001
      - AC-002
      - AC-003
      - AC-005
    description: |
      - ファイル: tests/test_log_tail_extractor_integration.py
      - エンドツーエンドの動作確認
      - 設定ファイルの読み込み
      - 通知メッセージのフォーマット
      - エラーハンドリング
      - 大きなファイルのパフォーマンス
  
  - id: T7
    title: ユニットテストの作成
    status: done
    priority: high
    estimated-hours: 0.5
    depends-on:
      - T1
      - T2
    validates:
      - AC-001
      - AC-004
      - AC-005
    description: |
      - ファイル: tests/test_log_tail_extractor_unit.py
      - extract_log_tail: 正常系
      - extract_log_tail: ファイルが存在しない
      - extract_log_tail: 読み込み権限がない
      - extract_log_tail: ファイルが空
      - extract_log_tail: 行数が少ない
      - format_alert_with_tail: 正常系
      - format_alert_with_tail: 末尾抜粋が空
      - 設定の読み込み
  
  - id: T8
    title: ドキュメント更新
    status: done
    priority: medium
    estimated-hours: 0.3
    depends-on:
      - T1
      - T2
      - T3
      - T4
    validates: []
    description: |
      - ファイル: README.md, docs/CHANGELOG.md
      - README.mdの機能一覧に追加
      - CHANGELOG.mdに変更内容を記録
      - 設定例を追加
  
  - id: T9
    title: 全テストの実行とカバレッジ確認
    status: done
    priority: high
    estimated-hours: 0.2
    depends-on:
      - T5
      - T6
      - T7
    validates: []
    description: |
      - bash run_coverage.sh
      - カバレッジ90%以上を確認
      - 全テストがパスすることを確認

implementation-order:
  - T1: ログ末尾抽出モジュールの作成
  - T7: ユニットテストの作成（T1の一部）
  - T5: プロパティテストの作成
  - T2: 通知メッセージのフォーマット関数
  - T3: main_log_monitor.pyの統合
  - T4: 設定ファイルの拡張
  - T6: 統合テストの作成
  - T8: ドキュメント更新
  - T9: 全テスト実行

completion-criteria:
  - 全てのタスクが完了している
  - 全テストがパスしている
  - カバレッジが90%以上
  - ログ急増通知に末尾抜粋が含まれる
  - 設定で行数を変更できる
  - 既存機能に影響がない
