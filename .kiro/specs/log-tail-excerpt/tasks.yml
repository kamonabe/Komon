# タスクリスト: ログ急増時の末尾抜粋表示

metadata:
  title: "ログ急増時の末尾抜粋表示"
  feature: "log-tail-excerpt"
  status: "pending"
  created: "2025-11-30"
  updated: "2025-11-30"
  completed: null
  version: "1.0.0"
  last_validated: null
  validation_passed: null

tasks:
  - id: "T1"
    title: "Extend log_watcher.py"
    status: "pending"
    priority: "high"
    estimated-hours: 1
    actual-hours: null
    depends-on: []
    validates: ["AC-001", "AC-002"]
    description: |
      log_watcher.pyを拡張し、
      ログ末尾取得機能とメッセージ整形機能を実装する
    subtasks:
      - "get_log_tail()関数を実装"
      - "_format_log_excerpt()関数を実装"
      - "check_log_growth()を拡張して末尾取得を統合"
      - "エラーハンドリングを追加"
      - "ロギングを追加"
    files:
      - path: "src/komon/log_watcher.py"
        action: "update"
        lines: 80
    tests: []
  
  - id: "T2"
    title: "Extend configuration files"
    status: "pending"
    priority: "high"
    estimated-hours: 0.5
    actual-hours: null
    depends-on: []
    validates: ["AC-003"]
    description: |
      設定ファイルにlog_tail_excerptセクションを追加し、
      デフォルト値を設定する
    subtasks:
      - "config/settings.yml.sampleにlog_tail_excerptセクションを追加"
      - "settings.ymlにlog_tail_excerptセクションを追加"
      - "デフォルト値を設定（tail_lines=10）"
    files:
      - path: "config/settings.yml.sample"
        action: "update"
        lines: 15
      - path: "settings.yml"
        action: "update"
        lines: 15
    tests: []
  
  - id: "T3"
    title: "Write property tests"
    status: "pending"
    priority: "high"
    estimated-hours: 0.5
    actual-hours: null
    depends-on: ["T1"]
    validates: ["AC-001", "AC-002"]
    description: |
      プロパティベーステストを作成し、
      3つの正確性プロパティを検証する
    subtasks:
      - "tests/test_log_tail_excerpt_properties.pyを作成"
      - "Property 1: 取得行数の正確性"
      - "Property 2: 末尾取得の冪等性"
      - "Property 3: メッセージ整形の一貫性"
    files:
      - path: "tests/test_log_tail_excerpt_properties.py"
        action: "create"
        lines: 80
    tests:
      - "tests/test_log_tail_excerpt_properties.py"
  
  - id: "T4"
    title: "Write integration tests"
    status: "pending"
    priority: "high"
    estimated-hours: 0.5
    actual-hours: null
    depends-on: ["T1", "T2"]
    validates: ["AC-001", "AC-002", "AC-003", "AC-004", "AC-005"]
    description: |
      統合テストを作成し、
      エンドツーエンドの動作とlog_watcher.pyとの統合を検証する
    subtasks:
      - "tests/test_log_tail_excerpt_integration.pyを作成"
      - "test_end_to_end_log_tail_excerpt"
      - "test_config_tail_lines"
      - "test_integration_with_log_watcher"
      - "test_backward_compatibility"
      - "test_performance_impact"
    files:
      - path: "tests/test_log_tail_excerpt_integration.py"
        action: "create"
        lines: 120
    tests:
      - "tests/test_log_tail_excerpt_integration.py"
  
  - id: "T5"
    title: "Write unit tests"
    status: "pending"
    priority: "high"
    estimated-hours: 0.5
    actual-hours: null
    depends-on: ["T1"]
    validates: ["AC-001", "AC-002"]
    description: |
      ユニットテストを作成し、
      各関数の正常系・異常系・エッジケースを検証する
    subtasks:
      - "tests/test_log_tail_excerpt_unit.pyを作成"
      - "get_log_tail()のテスト（4件）"
      - "_format_log_excerpt()のテスト（3件）"
    files:
      - path: "tests/test_log_tail_excerpt_unit.py"
        action: "create"
        lines: 100
    tests:
      - "tests/test_log_tail_excerpt_unit.py"
  
  - id: "T6"
    title: "Update documentation"
    status: "pending"
    priority: "medium"
    estimated-hours: 0.5
    actual-hours: null
    depends-on: ["T1", "T2", "T3", "T4", "T5"]
    validates: ["AC-001", "AC-002", "AC-003"]
    description: |
      ドキュメントを更新し、
      新機能の説明、設定例、出力例を追加する
    subtasks:
      - "README.mdに機能説明を追加"
      - "README.mdに設定例を追加"
      - "README.mdに出力例を追加"
      - "docs/CHANGELOG.mdに記録"
      - "docs/EXAMPLES.mdに出力例を追加"
    files:
      - path: "README.md"
        action: "update"
        lines: 20
      - path: "docs/CHANGELOG.md"
        action: "update"
        lines: 10
      - path: "docs/EXAMPLES.md"
        action: "update"
        lines: 15
    tests: []
  
  - id: "T7"
    title: "Run all tests and check coverage"
    status: "pending"
    priority: "high"
    estimated-hours: 0.5
    actual-hours: null
    depends-on: ["T3", "T4", "T5"]
    validates: ["AC-004"]
    description: |
      全テストを実行し、カバレッジを確認する。
      全テストがパスし、カバレッジが93%以上であることを確認する
    subtasks:
      - "python -m pytest tests/ -v"
      - "bash run_coverage.sh"
      - "カバレッジが93%以上であることを確認"
      - "README.mdのバッジを更新（必要な場合）"
    files:
      - path: "README.md"
        action: "update"
        lines: 1
    tests: []
  
  - id: "T8"
    title: "Manual verification"
    status: "pending"
    priority: "high"
    estimated-hours: 0.5
    actual-hours: null
    depends-on: ["T1", "T2", "T6", "T7"]
    validates: ["AC-001", "AC-002", "AC-003", "AC-004", "AC-005"]
    description: |
      手動で動作確認を行い、
      全ての受入基準が満たされていることを確認する
    subtasks:
      - "settings.ymlの確認"
      - "ログ急増を発生させる"
      - "Slack通知の確認"
      - "ログ抜粋の表示確認"
      - "tail_lines設定の変更テスト"
    files: []
    tests: []

completion-criteria:
  - id: "CC-001"
    description: "全テストがパス"
    status: "pending"
    validation: "pytest tests/ -v"
    result: null
  
  - id: "CC-002"
    description: "カバレッジ93%以上を維持"
    status: "pending"
    validation: "bash run_coverage.sh"
    result: null
  
  - id: "CC-003"
    description: "新規テストのカバレッジ90%以上"
    status: "pending"
    validation: "bash run_coverage.sh"
    result: null
  
  - id: "CC-004"
    description: "ドキュメント更新完了"
    status: "pending"
    validation: "manual"
    result: null
  
  - id: "CC-005"
    description: "手動動作確認完了"
    status: "pending"
    validation: "manual"
    result: null
  
  - id: "CC-006"
    description: "implementation-tasks.mdのステータス更新"
    status: "pending"
    validation: "manual"
    result: null
  
  - id: "CC-007"
    description: "CHANGELOG.mdに記録"
    status: "pending"
    validation: "manual"
    result: null

execution-plan:
  parallel-tasks:
    - ["T2"]  # T1と並行実行可能
    - ["T3", "T5"]  # T1完了後、並行実行可能
  
  critical-path:
    - "T1"  # log_watcher.py拡張
    - "T4"  # 統合テスト
    - "T6"  # ドキュメント更新
    - "T7"  # 全テスト実行
    - "T8"  # 手動確認
  
  total-estimated-hours: 3

risks:
  - task: "T1"
    risk: "巨大なログファイルの読み込みパフォーマンス"
    mitigation: "末尾のみを効率的に読み込む方式を採用、50ms以内を保証"
    probability: "low"
    impact: "medium"
  
  - task: "T1"
    risk: "機密情報の漏洩"
    mitigation: "ドキュメントで警告、将来的にマスキング機能を検討"
    probability: "medium"
    impact: "high"
  
  - task: "T4"
    risk: "既存機能への影響"
    mitigation: "統合テストで確認、機能フラグで制御"
    probability: "low"
    impact: "high"
