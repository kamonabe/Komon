metadata:
  title: ãƒ­ã‚°æ€¥å¢—æ™‚ã®æœ«å°¾æŠœç²‹è¡¨ç¤º - è¨­è¨ˆæ›¸
  feature: log-tail-excerpt
  status: draft
  created: 2025-11-30
  updated: 2025-11-30
  version: "1.0.0"
  last_validated: null
  validation_passed: null

architecture:
  modules:
    - name: log_tail_extractor.py
      location: src/komon/
      status: new
      description: ãƒ­ã‚°æœ«å°¾æŠ½å‡ºãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    
    - name: main_log_monitor.py
      location: scripts/
      status: modified
      description: æœ«å°¾æŠœç²‹æ©Ÿèƒ½ã‚’çµ±åˆ
    
    - name: settings.yml.sample
      location: config/
      status: modified
      description: è¨­å®šé …ç›®ã‚’è¿½åŠ 
  
  data-flow: |
    1. LogWatcher: ãƒ­ã‚°å·®åˆ†ã‚’æ¤œå‡º
    2. check_log_anomaly: ç•°å¸¸åˆ¤å®š
    3. extract_log_tail: ãƒ­ã‚°æœ«å°¾ã‚’æŠ½å‡ºï¼ˆæ–°è¦ï¼‰
    4. format_alert_message: é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆï¼ˆå¤‰æ›´ï¼‰
    5. send_slack_alert / send_email_alert: é€šçŸ¥é€ä¿¡

correctness-properties:
  - id: P1
    title: è¡Œæ•°ã‚«ã‚¦ãƒ³ãƒˆã®æ­£ç¢ºæ€§
    type: invariant
    description: '*ä»»æ„ã®*è¡Œæ•°ã®ãƒ­ã‚°ã«å¯¾ã—ã¦ã€æŠ½å‡ºçµæœã®è¡Œæ•°ã¯æŒ‡å®šã—ãŸè¡Œæ•°ã¨ä¸€è‡´ã™ã‚‹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã®è¡Œæ•°ãŒå°‘ãªã„å ´åˆã‚’é™¤ãï¼‰'
    validates:
      - AC-001
    test-strategy: property-based
    implementation:
      framework: hypothesis
      strategy: st.lists(st.text(), min_size=1, max_size=100)
      assertion: len(result) == min(requested_lines, len(lines))
  
  - id: P2
    title: æœ«å°¾ã‹ã‚‰ã®é †åºæ€§
    type: invariant
    description: '*ä»»æ„ã®*ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦ã€æŠ½å‡ºã•ã‚ŒãŸè¡Œã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ«å°¾ã‹ã‚‰æŒ‡å®šè¡Œæ•°åˆ†ã‚’å¤ã„é †ã«ä¸¦ã¹ãŸã‚‚ã®ã§ã‚ã‚‹'
    validates:
      - AC-001
    test-strategy: property-based
    implementation:
      framework: hypothesis
      strategy: st.lists(st.text(min_size=1), min_size=10, max_size=100)
      assertion: result == lines[-requested_lines:]
  
  - id: P3
    title: é•·ã„è¡Œã®åˆ‡ã‚Šè©°ã‚
    type: invariant
    description: '*ä»»æ„ã®*ãƒ­ã‚°è¡Œã«ã¤ã„ã¦ã€1è¡ŒãŒæœ€å¤§æ–‡å­—æ•°ã‚’è¶…ãˆã‚‹å ´åˆã€é©åˆ‡ã«åˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã‚‹'
    validates:
      - AC-004
    test-strategy: property-based
    implementation:
      framework: hypothesis
      strategy: st.lists(st.text(min_size=1, max_size=1000), min_size=1, max_size=10)
      assertion: all(len(line) <= max_length + len(" ... (truncated)") for line in result)

detailed-design:
  log-tail-extractor:
    file: src/komon/log_tail_extractor.py
    functions:
      - name: extract_log_tail
        signature: "extract_log_tail(log_path: str, lines: int = 10, max_line_length: int = 500) -> list[str]"
        description: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ«å°¾Nè¡Œã‚’æŠ½å‡º
        algorithm: |
          1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ«å°¾ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼ˆseek(-1, 2)ï¼‰
          2. æ”¹è¡Œã‚’æ¤œå‡ºã—ãªãŒã‚‰é€†é †ã«èª­ã‚€
          3. æŒ‡å®šè¡Œæ•°ã«é”ã—ãŸã‚‰åœæ­¢
          4. çµæœã‚’åè»¢ã—ã¦è¿”ã™ï¼ˆå¤ã„é †ã«ï¼‰
        performance:
          - å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚é«˜é€Ÿï¼ˆæœ«å°¾ã®ã¿èª­ã¿è¾¼ã‚€ï¼‰
          - ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚º: 8KB
          - æœ€å¤§èª­ã¿è¾¼ã¿ã‚µã‚¤ã‚º: 100KBï¼ˆå®‰å…¨è£…ç½®ï¼‰
        error-handling:
          - FileNotFoundError: ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„
          - PermissionError: èª­ã¿è¾¼ã¿æ¨©é™ãŒãªã„
          - ç©ºãƒ•ã‚¡ã‚¤ãƒ«: ç©ºãƒªã‚¹ãƒˆã‚’è¿”ã™
  
  message-formatting:
    file: scripts/main_log_monitor.py
    functions:
      - name: format_alert_with_tail
        signature: "format_alert_with_tail(alert: str, log_path: str, tail_lines: list[str]) -> str"
        description: è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æœ«å°¾æŠœç²‹ã‚’è¿½åŠ 
        format: |
          âš ï¸ {alert}
          
          ğŸ“„ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: {log_path}
          ğŸ“‹ æœ«å°¾ {len(tail_lines)} è¡Œ:
          ```
          {tail_lines}
          ```
  
  configuration:
    file: config/settings.yml.sample
    new-settings:
      log_analysis:
        tail_lines: 10
        max_line_length: 500

resilience:
  circuit-breaker:
    considered: true
    decision: not-adopted
    rationale: Komonã¯çŸ­å‘½ãªCLI/ãƒãƒƒãƒãƒ„ãƒ¼ãƒ«ã§ã‚ã‚Šã€ç¶™ç¶šçš„ãªæ¥ç¶šç¶­æŒã‚„å¤§é‡ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æ‰±ã‚ãªã„
  
  notification-throttling:
    considered: true
    decision: delegated
    rationale: æ—¢å­˜ã®throttleæ©Ÿèƒ½ã§å¯¾å¿œæ¸ˆã¿
  
  other-considerations:
    - consideration: ãƒ‡ãƒ¼ã‚¿æ¬ ææ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      decision: adopted
      rationale: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã‚ãªã„å ´åˆã§ã‚‚ã€é€šçŸ¥ã¯ç¶™ç¶šã™ã‚‹
      implementation:
        - æœ«å°¾æŠœç²‹ãªã—ã§é€šçŸ¥ã‚’é€ä¿¡
        - ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
    
    - consideration: ç•°å¸¸å€¤ã®é™¤å¤–
      decision: not-applicable
      rationale: ãƒ­ã‚°å†…å®¹ã¯åŠ å·¥ã›ãšã€ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹

test-strategy:
  property-tests:
    count: 3
    file: tests/test_log_tail_extractor_properties.py
    tests:
      - Property 1: è¡Œæ•°ã‚«ã‚¦ãƒ³ãƒˆã®æ­£ç¢ºæ€§
      - Property 2: æœ«å°¾ã‹ã‚‰ã®é †åºæ€§
      - Property 3: é•·ã„è¡Œã®åˆ‡ã‚Šè©°ã‚
  
  integration-tests:
    count: 5
    file: tests/test_log_tail_extractor_integration.py
    tests:
      - ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®å‹•ä½œç¢ºèª
      - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
      - é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      - å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
  
  unit-tests:
    count: 8
    file: tests/test_log_tail_extractor_unit.py
    tests:
      - extract_log_tail: æ­£å¸¸ç³»
      - extract_log_tail: ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„
      - extract_log_tail: èª­ã¿è¾¼ã¿æ¨©é™ãŒãªã„
      - extract_log_tail: ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©º
      - extract_log_tail: è¡Œæ•°ãŒå°‘ãªã„
      - format_alert_with_tail: æ­£å¸¸ç³»
      - format_alert_with_tail: æœ«å°¾æŠœç²‹ãŒç©º
      - è¨­å®šã®èª­ã¿è¾¼ã¿

performance-targets:
  - metric: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ«å°¾èª­ã¿è¾¼ã¿
    target: 1ç§’ä»¥å†…
  - metric: å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ1GBä»¥ä¸Šï¼‰
    target: é«˜é€Ÿå‹•ä½œ
  - metric: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
    target: 1MBä»¥å†…ï¼ˆæœ«å°¾ã®ã¿èª­ã¿è¾¼ã‚€ãŸã‚ï¼‰

security-considerations:
  - ãƒ­ã‚°ã«æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§
  - è¨­å®šã§æœ«å°¾æŠœç²‹ã‚’ç„¡åŠ¹åŒ–å¯èƒ½ï¼ˆtail_lines: 0ï¼‰
  - é€šçŸ¥å…ˆã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è²¬ä»»
