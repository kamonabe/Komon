---
title: 週次健全性レポート - 設計書
feature: weekly-health-report
status: implemented
created: 2025-11-22
updated: 2025-11-25
---

# 週次健全性レポート - 設計書

## 概要

週次健全性レポート機能は、過去7日間のシステムリソース使用率を分析し、先週比、トレンド、警戒情報を含むレポートを生成します。Slack/メール通知と統合し、管理者がSSHログインせずにシステム状態を確認できます。

設計の主要な方針：
- データ収集と分析の分離
- 既存の通知システムとの統合
- グレースフルデグラデーション（データ不足時も動作）
- 読みやすいメッセージフォーマット

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    scripts/weekly_report.py                  │
│  (メインエントリーポイント、レポート生成を統括)                │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ├──> settings.yml を読み込み
                     │
                     ├──> 履歴データを収集（7日分）
                     │    └─> data/usage_history/*.json
                     │
                     ├──> 先週比を計算
                     │
                     ├──> 警戒履歴を取得
                     │    └─> data/notifications/queue.json
                     │
                     ├──> トレンドを分析
                     │
                     ├──> レポートメッセージを生成
                     │
                     └──> 通知を送信
                          ├─> Slack（有効な場合）
                          └─> メール（有効な場合）
```

## コンポーネントとインターフェース

### 1. 週次レポートスクリプト (`scripts/weekly_report.py`)

**責務:**
- レポート生成プロセス全体を統括
- settings.yml から設定を読み込み
- データ収集と分析を調整
- レポートをフォーマットして送信

**主要関数:**
```python
def main():
    """週次レポート生成のメインエントリーポイント"""
    
def load_config(path: str = "settings.yml") -> dict:
    """YAMLファイルから設定を読み込む"""
    
def generate_weekly_report(config: dict) -> str:
    """週次健全性レポートメッセージを生成"""
```

### 2. データ収集モジュール (`src/komon/weekly_data.py`)

**責務:**
- 履歴リソース使用率データの収集
- 平均値と比較の計算
- 警戒履歴の取得

**主要関数:**
```python
def collect_weekly_data() -> dict:
    """
    過去7日間のリソース使用率データを収集
    
    Returns:
        dict: {
            'current': {'cpu': 45.2, 'mem': 62.8, 'disk': 68.5},
            'previous': {'cpu': 43.1, 'mem': 64.3, 'disk': 65.3},
            'change': {'cpu': +2.1, 'mem': -1.5, 'disk': +3.2}
        }
    """
    
def get_alert_history(days: int = 7) -> list:
    """
    過去N日間の警戒通知を取得
    
    Returns:
        list: [
            {'timestamp': '2025-11-20 15:30', 'type': 'cpu', 'message': '...'},
            ...
        ]
    """
    
def analyze_trend(current: float, previous: float, threshold: float = 5.0) -> str:
    """
    リソース使用率のトレンドを分析
    
    Returns:
        str: 'stable', 'increasing', または 'decreasing'
    """
```

### 3. レポートフォーマッター (`src/komon/report_formatter.py`)

**責務:**
- レポートデータを人間が読みやすいメッセージにフォーマット
- 視覚的インジケーター（絵文字、シンボル）の適用
- 異なる出力形式のサポート（Slack/メール）

**主要関数:**
```python
def format_weekly_report(data: dict) -> str:
    """
    週次レポートデータをメッセージにフォーマット
    
    Args:
        data: collect_weekly_data() からのレポートデータ
        
    Returns:
        str: フォーマット済みレポートメッセージ
    """
    
def format_resource_status(resource: str, current: float, change: float) -> str:
    """個別リソース状態行をフォーマット"""
    
def format_trend_indicator(trend: str) -> str:
    """
    トレンドを視覚的インジケーターに変換
    
    Returns:
        '✅ 安定' for stable
        '⚠️ 増加傾向' for increasing
        '📉 減少傾向' for decreasing
    """
```

## データ構造

### 週次レポートデータ
```python
{
    'period': {
        'start': '2025-11-18',
        'end': '2025-11-24'
    },
    'resources': {
        'cpu': {
            'current': 45.2,
            'previous': 43.1,
            'change': +2.1,
            'trend': 'stable'
        },
        'mem': {
            'current': 62.8,
            'previous': 64.3,
            'change': -1.5,
            'trend': 'stable'
        },
        'disk': {
            'current': 68.5,
            'previous': 65.3,
            'change': +3.2,
            'trend': 'increasing'
        }
    },
    'alerts': [
        {
            'timestamp': '2025-11-20 15:30',
            'type': 'cpu',
            'message': 'CPU使用率が85%を超えました'
        }
    ]
}
```

### 設定 (settings.yml)
```yaml
weekly_report:
  enabled: true
  day_of_week: 1  # 0=Sunday, 1=Monday, ..., 6=Saturday
  hour: 9
  minute: 0
  notifications:
    slack: true
    email: false
```

## メッセージフォーマット

### Slack/メールメッセージテンプレート
```
📊 週次健全性レポート (2025-11-18 〜 2025-11-24)

【リソース状況】
CPU使用率: 45.2% (先週比 +2.1%)
メモリ使用率: 62.8% (先週比 -1.5%)
ディスク使用率: 68.5% (先週比 +3.2%)

【今週の警戒情報】
- 11/20 15:30 - CPU使用率が85%を超えました
- 11/22 03:15 - ログ急増を検出 (/var/log/messages)

【トレンド】
✅ CPU: 安定
✅ メモリ: 安定
⚠️ ディスク: 緩やかに増加傾向

異常がなくても、定期的に確認しておくと安心ですね 👀
```

## 正確性プロパティ

*プロパティとは、システムの全ての有効な実行において真であるべき特性や振る舞いのことです。本質的には、システムが何をすべきかについての形式的な記述です。プロパティは、人間が読める仕様と機械で検証可能な正確性保証との橋渡しをします。*

### プロパティ1: データの正確性
*任意の*現在値と前回値について、先週比の計算は `((current - previous) / previous) * 100` と一致しなければならない
**検証対象: 要件 AC-001.2, AC-002.2**

### プロパティ2: 日付範囲の正確性
*任意の*レポート期間について、常に正確に7日間をカバーしなければならない
**検証対象: 要件 AC-002.1**

### プロパティ3: トレンド分類
*任意の*変化率について、|change| < 5%の場合は'stable'、change >= 5%の場合は'increasing'、change <= -5%の場合は'decreasing'と分類されなければならない
**検証対象: 要件 AC-001.4**

### プロパティ4: 警戒履歴の完全性
*任意の*7日間の期間について、期間内の全ての警戒情報がレポートに含まれなければならない
**検証対象: 要件 AC-001.3, AC-002.3**

### プロパティ5: グレースフルデグラデーション
*任意の*履歴データ不足について、レポート生成を妨げず「データ不足」と表示しなければならない
**検証対象: 要件 AC-002.4**

## テスト戦略

### プロパティベーステスト

Pythonの`hypothesis`ライブラリを使用します。

**設定:**
- 最小実行回数: 100回
- タイムアウト: テストごとに30秒

**テスト対象:**
- プロパティ1: データの正確性
- プロパティ2: 日付範囲の正確性
- プロパティ3: トレンド分類
- プロパティ4: 警戒履歴の完全性
- プロパティ5: グレースフルデグラデーション

**テストファイル:** `tests/test_weekly_data_properties.py`

### ユニットテスト

Pythonの標準`unittest`フレームワークを使用します。

**テスト対象:**
- データ収集関数
- 計算精度（先週比）
- トレンド分析ロジック
- メッセージフォーマット

**テストファイル:** `tests/test_weekly_data.py`, `tests/test_report_formatter.py`

### 統合テスト

**テストシナリオ:**
1. エンドツーエンドのレポート生成
2. 通知配信（モック）
3. 設定読み込み
4. 警戒履歴のフィルタリング

**テストファイル:** `tests/test_weekly_report_integration.py`

### 手動テスト

**確認項目:**
1. レポート生成が成功するか
2. Slack通知が正しく送信されるか
3. メール通知が正しく送信されるか
4. データ不足時に適切に処理されるか

## 元の正確性プロパティ詳細

### P1: データの正確性
**プロパティ:** 先週比の計算は数学的に正確であること。
```
change_percent = ((current - previous) / previous) * 100
```

**検証方法:** hypothesisによるプロパティベーステスト
- 様々な現在値/前回値でテスト
- 計算精度の検証
- エッジケースの処理（previous = 0）

### P2: 日付範囲の正確性
**プロパティ:** レポートは常に正確に7日間をカバーすること。
```
end_date - start_date = 7 days
```

**検証方法:** ユニットテスト
- 日付範囲計算のテスト
- 境界条件の検証

### P3: トレンド分類
**プロパティ:** トレンド分析は一貫性があること。
```
IF |change| < 5% THEN trend = 'stable'
IF change >= 5% THEN trend = 'increasing'
IF change <= -5% THEN trend = 'decreasing'
```

**検証方法:** プロパティベーステスト
- 様々な変化値でテスト
- 閾値境界の検証

### P4: 警戒履歴の完全性
**プロパティ:** 7日間の期間内の全ての警戒情報が含まれること。
```
FOR ALL alerts IN notification_history:
    IF start_date <= alert.timestamp <= end_date:
        THEN alert IN report.alerts
```

**検証方法:** 統合テスト
- 日付範囲内外のテスト警戒情報を作成
- 正しいフィルタリングの検証

### P5: グレースフルデグラデーション
**プロパティ:** 履歴データが不足していてもレポート生成を妨げないこと。
```
IF historical_data IS incomplete:
    THEN report SHALL indicate "データ不足" for affected metrics
    AND report generation SHALL continue
```

**検証方法:** ユニットテスト
- データファイル不足時のテスト
- 部分的なデータでのテスト
- エラーハンドリングの検証

## エラーハンドリング

### 履歴データの不足
- **シナリオ:** `data/usage_history/` にデータファイルがない
- **動作:** 影響を受けるメトリクスに「データ不足」と表示
- **ユーザーメッセージ:** "過去7日分のデータが不足しています"

### 通知配信の失敗
- **シナリオ:** Slack/メール配信が失敗
- **動作:** エラーをログに記録し、実行を継続
- **ユーザーメッセージ:** エラー詳細をコンソール出力

### 設定エラー
- **シナリオ:** settings.yml が無効
- **動作:** デフォルト値を使用
- **ユーザーメッセージ:** デフォルト値使用の警告

## テスト戦略

### ユニットテスト
- データ収集関数
- 計算精度（先週比）
- トレンド分析ロジック
- メッセージフォーマット

### プロパティベーステスト (hypothesis)
- ランダム入力での計算正確性
- トレンド分類の一貫性
- 日付範囲の検証

### 統合テスト
- エンドツーエンドのレポート生成
- 通知配信（モック）
- 設定読み込み

### エッジケース
- 空の履歴データ
- 1日分のみのデータ
- 全警戒情報 vs 警戒情報なし
- 極端な変化率

## パフォーマンス考慮事項

- 履歴データ読み込み: O(n) ただし n = 7日
- 警戒情報フィルタリング: O(m) ただし m = 全警戒情報数
- 予想実行時間: < 5秒
- メモリ使用量: < 50MB

## セキュリティ考慮事項

- レポートメッセージに機密データを含めない
- Webhook URLはsettings.ymlに安全に保存
- メール認証情報は環境変数経由

## 将来の拡張

- カスタマイズ可能なレポート頻度（日次/月次）
- レポート履歴の保存
- グラフィカルチャート（matplotlib統合）
- 複数サーバーの集約
