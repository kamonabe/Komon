---
title: 週次健全性レポート - 要件定義
feature: weekly-health-report
status: implemented
created: 2025-11-22
updated: 2025-11-25
---

# 週次健全性レポート - 要件定義書

## 概要

この機能は、システム監視のための定期的な健全性レポートを提供します。管理者がSSHログインせずにシステム状態を確認できるようにし、特に年末年始などの長期休暇前に有用です。

## 用語集

- **週次レポート**: 毎週定期的に生成されるシステム健全性レポート
- **先週比**: 前週の平均値との比較（変化率）
- **トレンド分析**: リソース使用率の傾向分析（安定/増加/減少）
- **警戒履歴**: 過去の通知履歴から抽出した警告情報
- **usage_history**: リソース使用率の履歴データ（`data/usage_history/`）
- **notification_history**: 通知履歴データ（`data/notifications/queue.json`）
- **Cronスケジューリング**: 定期実行のためのスケジュール設定
- **健全性指標**: システムの健全性を示すメトリクス（CPU/メモリ/ディスク）

## 受入基準

### [AC-001] 週次レポートの生成

**ユーザーストーリー:** システム管理者として、SSHログインせずにシステム状態を確認したいので、定期的な健全性レポートが必要です。

#### 受入条件

1. **WHEN** 週次レポートスクリプトが実行されたとき、**THEN** 現在のリソース使用率（CPU、メモリ、ディスク）を含むレポートを生成すること
2. **WHEN** レポートを生成するとき、**THEN** 先週比の比較（変化率）を含めること
3. **WHEN** レポートを生成するとき、**THEN** 過去7日間の警戒情報サマリーを含めること
4. **WHEN** レポートを生成するとき、**THEN** トレンド分析（安定/増加傾向/減少傾向）を含めること
5. **WHEN** レポート生成が完了したとき、**THEN** 10秒以内に完了すること

### [AC-002] 履歴データの収集

**ユーザーストーリー:** 開発者として、正確なレポートを生成するために、履歴データを適切に収集・分析する必要があります。

#### 受入条件

1. **WHEN** 週次レポートを生成するとき、**THEN** 過去7日間のリソース使用率データを収集すること
2. **WHEN** 先週比を計算するとき、**THEN** 前週の平均値を使用すること
3. **WHEN** 警戒情報を収集するとき、**THEN** 通知履歴から過去7日間の情報を抽出すること
4. **WHEN** 履歴データが不足しているとき、**THEN** 「データ不足」と表示し、レポート生成を継続すること
5. **WHEN** データ収集が失敗したとき、**THEN** エラーをログに記録し、適切に処理すること

### [AC-003] Slack通知との統合

**ユーザーストーリー:** システム管理者として、Slackで週次レポートを受け取りたいので、Slack通知との統合が必要です。

#### 受入条件

1. **WHEN** 設定でSlack通知が有効になっている場合、**THEN** 設定されたSlack Webhook URLにレポートを送信すること
2. **WHEN** Slack送信が失敗した場合、**THEN** エラーをログに記録し、レポート生成を継続すること
3. **WHEN** Slackメッセージを送信するとき、**THEN** 読みやすい形式でフォーマットすること
4. **WHEN** Webhook URLが設定されていない場合、**THEN** 警告を表示し、送信をスキップすること
5. **WHEN** Slack送信が成功した場合、**THEN** 成功メッセージをログに記録すること

### [AC-004] メール通知との統合

**ユーザーストーリー:** システム管理者として、メールで週次レポートを受け取りたいので、メール通知との統合が必要です。

#### 受入条件

1. **WHEN** 設定でメール通知が有効になっている場合、**THEN** 設定されたメールアドレスにレポートを送信すること
2. **WHEN** メール送信が失敗した場合、**THEN** エラーをログに記録し、レポート生成を継続すること
3. **WHEN** メールメッセージを送信するとき、**THEN** 読みやすい形式でフォーマットすること
4. **WHEN** メールアドレスが設定されていない場合、**THEN** 警告を表示し、送信をスキップすること
5. **WHEN** メール送信が成功した場合、**THEN** 成功メッセージをログに記録すること

### [AC-005] 設定の制御

**ユーザーストーリー:** システム管理者として、週次レポートの動作を調整したいので、設定ファイルで制御できる必要があります。

#### 受入条件

1. **WHEN** ユーザーが設定ファイルを編集するとき、**THEN** 週次レポートの有効/無効を切り替えられること
2. **WHEN** ユーザーが設定ファイルを編集するとき、**THEN** レポート生成の曜日と時刻を設定できること
3. **WHEN** ユーザーが設定ファイルを編集するとき、**THEN** 通知チャネル（Slack/メール/両方）を選択できること
4. **WHEN** 設定が不正な場合、**THEN** デフォルト値を使用し、警告を表示すること
5. **WHEN** 設定ファイルが存在しない場合、**THEN** デフォルト設定で動作すること

### [AC-006] Cronスケジューリング

**ユーザーストーリー:** システム管理者として、週次レポートを自動実行したいので、cronスケジューリングの設定方法が必要です。

#### 受入条件

1. **WHEN** ドキュメントを参照するとき、**THEN** 週次実行のためのcron設定例が提供されていること
2. **WHEN** ドキュメントを参照するとき、**THEN** スケジューリング設定の手順が記載されていること
3. **WHEN** デフォルト推奨設定を使用するとき、**THEN** 毎週月曜日9時に実行されること
4. **WHEN** cron設定を変更するとき、**THEN** 任意の曜日と時刻を設定できること
5. **WHEN** cron設定例をコピーするとき、**THEN** そのまま使用可能な形式であること

## 非機能要件

### NFR-1: パフォーマンス
- レポート生成は10秒以内に完了すること
- 履歴データの取得はシステムパフォーマンスに影響を与えないこと

### NFR-2: 信頼性
- レポート生成は履歴データが不足していても適切に処理すること
- 通知配信の失敗はレポート生成を妨げないこと

### NFR-3: 使いやすさ
- レポート形式はSlack/メールで読みやすいこと
- トレンド指標は明確な視覚的シンボルを使用すること（✅ ⚠️）

### NFR-4: 保守性
- レポートロジックは通知ロジックから分離されていること
- メッセージテンプレートは容易にカスタマイズ可能であること

## スコープ外

- 日次または時間単位のレポート頻度（週次のみ）
- UI経由のカスタムレポートテンプレート
- レポート履歴の保存（現在のレポートのみ送信）
- 複数サーバーの集約

## 依存関係

- 既存の通知システム（Slack/メール）
- `data/usage_history/` の履歴データストレージ
- `data/notifications/` の通知履歴

## 成功指標

- レポート生成成功率 > 99%
- レポート配信は生成後1分以内
- ユーザー満足度: 「健全性確認のためにSSHする必要がない」
