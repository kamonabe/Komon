metadata:
  title: "ãƒ­ã‚°å‚¾å‘åˆ†æã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ"
  feature: "log-trends-analysis-system"
  status: "draft"
  created: "2025-12-17"
  updated: "2025-12-17"
  version: "1.0.0"

# æ­£ç¢ºæ€§ç‰¹æ€§
correctness-properties:
  - id: "P1"
    description: "å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§"
    property: "ä¿å­˜ã•ã‚ŒãŸå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯å¸¸ã«æ—¥ä»˜æ˜‡é †ã§ã€æœ€å¤§30æ—¥åˆ†ä»¥å†…ã§ã‚ã‚‹"
    test_strategy: "å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ã¨ä»¶æ•°ç¢ºèª"
    validates: ["AC-001"]

  - id: "P2"
    description: "å¢—åŠ ç‡è¨ˆç®—ã®æ­£ç¢ºæ€§"
    property: "å¢—åŠ ç‡ = ((ç¾åœ¨å€¤ - å‰æ—¥å€¤) / max(å‰æ—¥å€¤, 1)) * 100 ã®å¼ã§æ­£ç¢ºã«è¨ˆç®—ã•ã‚Œã‚‹"
    test_strategy: "æ—¢çŸ¥ã®å€¤ã§ã®è¨ˆç®—çµæœç¢ºèª"
    validates: ["AC-002"]

  - id: "P3"
    description: "é€£ç¶šæ€¥å¢—æ¤œå‡ºã®ä¸€è²«æ€§"
    property: "Næ—¥é–“ã§Nå›ä»¥ä¸Šã®æ€¥å¢—ï¼ˆ20%ä»¥ä¸Šï¼‰ãŒã‚ã£ãŸå ´åˆã€å¿…ãšTrueã‚’è¿”ã™"
    test_strategy: "é€£ç¶šæ€¥å¢—ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã®æ¤œå‡ºç¢ºèª"
    validates: ["AC-003"]

  - id: "P4"
    description: "ã‚¨ãƒ©ãƒ¼è€æ€§ã®ä¿è¨¼"
    property: "ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ»ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã€ã‚·ã‚¹ãƒ†ãƒ ã¯é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ç¶™ç¶šå‹•ä½œã™ã‚‹"
    test_strategy: "ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼æ™‚ã®å‹•ä½œç¢ºèª"
    validates: ["AC-004"]

# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦
architecture:
  pattern: "Time Series Analysis Pattern + Repository Pattern"
  description: "æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®åˆ†æã¨æ°¸ç¶šåŒ–ã‚’åˆ†é›¢ã—ã€æ‹¡å¼µå¯èƒ½ãªè¨­è¨ˆ"
  
  components:
    trend_analyzer:
      description: "å‚¾å‘åˆ†æã®ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ"
      responsibilities:
        - "ç¾åœ¨ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨å±¥æ­´ã¨ã®æ¯”è¼ƒ"
        - "å¢—åŠ ç‡ã®è¨ˆç®—ã¨åˆ¤å®š"
        - "åˆ†æçµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ"
    
    history_repository:
      description: "å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ç®¡ç†"
      responsibilities:
        - "å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãƒ»ä¿å­˜"
        - "30æ—¥åˆ†ã®è‡ªå‹•ç®¡ç†"
        - "ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®æ­£è¦åŒ–"
    
    spike_detector:
      description: "æ€¥å¢—ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º"
      responsibilities:
        - "é€£ç¶šæ€¥å¢—ã®åˆ¤å®š"
        - "é–¾å€¤ã¨ã®æ¯”è¼ƒ"
        - "ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°"
    
    state_reader:
      description: "çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—"
      responsibilities:
        - "pickleå½¢å¼ã®çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿"
        - "è¾æ›¸ãƒ»æ•°å€¤å½¢å¼ã®ä¸¡æ–¹ã«å¯¾å¿œ"
        - "ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"

# ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
data_structures:
  HistoryEntry:
    type: "Dict"
    structure:
      date: "str (YYYY-MM-DDå½¢å¼)"
      lines: "int (ãƒ­ã‚°è¡Œæ•°)"
  
  HistoryData:
    type: "List[HistoryEntry]"
    constraints:
      - "æ—¥ä»˜æ˜‡é †ã§ã‚½ãƒ¼ãƒˆ"
      - "æœ€å¤§30ã‚¨ãƒ³ãƒˆãƒª"
      - "é‡è¤‡æ—¥ä»˜ãªã—"
  
  StateData:
    type: "Union[Dict, int]"
    formats:
      dict_format: "{'last_line': int, ...}"
      numeric_format: "int (ç›´æ¥ã®è¡Œæ•°)"

# å‡¦ç†ãƒ•ãƒ­ãƒ¼
processing_flow:
  trend_analysis_flow:
    1: "çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç¾åœ¨è¡Œæ•°å–å¾—"
    2: "å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿"
    3: "æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã®è¿½åŠ "
    4: "30æ—¥åˆ¶é™ã§ã®å¤ã„ãƒ‡ãƒ¼ã‚¿å‰Šé™¤"
    5: "å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜"
    6: "å‰æ—¥æ¯”å¢—åŠ ç‡ã®è¨ˆç®—"
    7: "çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ"
  
  spike_detection_flow:
    1: "å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿"
    2: "æŒ‡å®šæ—¥æ•°åˆ†ã®ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ç¢ºèª"
    3: "å„æ—¥ã®å‰æ—¥æ¯”å¢—åŠ ç‡è¨ˆç®—"
    4: "é–¾å€¤ï¼ˆ20%ï¼‰è¶…éå›æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ"
    5: "é€£ç¶šæ€¥å¢—åˆ¤å®šçµæœã®è¿”å´"

# ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è©³ç´°
algorithms:
  increase_rate_calculation:
    description: "å‰æ—¥æ¯”å¢—åŠ ç‡ã®è¨ˆç®—"
    formula: "((current - previous) / max(previous, 1)) * 100"
    edge_cases:
      - "previous = 0: åˆ†æ¯ã‚’1ã¨ã—ã¦è¨ˆç®—"
      - "current < 0: è² ã®å€¤ã‚‚æ­£å¸¸ã«å‡¦ç†"
      - "ãƒ‡ãƒ¼ã‚¿å‹æ··åœ¨: è¾æ›¸ãƒ»æ•°å€¤ä¸¡æ–¹ã«å¯¾å¿œ"
  
  history_management:
    description: "å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ "
    logic: |
      1. æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
      2. æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
      3. 30æ—¥ã‚’è¶…ãˆã‚‹å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
      4. JSONå½¢å¼ã§ä¿å­˜
    constraints:
      - "æœ€å¤§30ã‚¨ãƒ³ãƒˆãƒª"
      - "æ—¥ä»˜é‡è¤‡ãªã—"
      - "æ˜‡é †ã‚½ãƒ¼ãƒˆç¶­æŒ"

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥
error_handling:
  file_access_errors:
    state_file_missing:
      message: "ãƒ‡ãƒ¼ã‚¿ä¸è¶³ï¼ˆåˆå›å®Ÿè¡Œï¼‰"
      recovery: "åˆå›å®Ÿè¡Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º"
    
    state_file_corrupt:
      message: "çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼"
      recovery: "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦å‡¦ç†ç¶™ç¶š"
    
    history_save_error:
      message: "å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼: {error}"
      recovery: "è­¦å‘Šè¡¨ç¤ºã—ã¦åˆ†æã¯ç¶™ç¶š"
  
  data_validation_errors:
    insufficient_data:
      condition: "å±¥æ­´ãŒ2æ—¥æœªæº€"
      message: "ãƒ‡ãƒ¼ã‚¿è“„ç©ä¸­ï¼ˆ{days}æ—¥åˆ†ï¼‰"
      recovery: "è“„ç©çŠ¶æ³ã‚’è¡¨ç¤º"
    
    invalid_data_format:
      condition: "çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿ãŒäºˆæœŸã—ãªã„å½¢å¼"
      message: "ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼"
      recovery: "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§å‡¦ç†ç¶™ç¶š"

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­è¨ˆ
performance_design:
  optimization_strategies:
    - "å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã®è»½é‡åŒ–ï¼ˆJSONæœ€å°åŒ–ï¼‰"
    - "ãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿å‡¦ç†"
    - "ä¸è¦ãªè¨ˆç®—ã®å›é¿"
  
  complexity_analysis:
    trend_analysis: "O(n) - nã¯å±¥æ­´æ—¥æ•°ï¼ˆæœ€å¤§30ï¼‰"
    spike_detection: "O(n) - nã¯æ¤œæŸ»æ—¥æ•°"
    history_management: "O(n log n) - ã‚½ãƒ¼ãƒˆå‡¦ç†"
    memory: "O(1) - å›ºå®šã‚µã‚¤ã‚ºå±¥æ­´"

# æ‹¡å¼µæ€§è¨­è¨ˆ
extensibility:
  new_detection_patterns:
    description: "æ–°ã—ã„æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¿½åŠ æ–¹æ³•"
    approach: "spike_detectorå†…ã«æ–°ã—ã„åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ "
    examples:
      - "é€±æ¬¡ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º"
      - "å­£ç¯€æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º"
      - "ç•°å¸¸å€¤é™¤å¤–æ©Ÿèƒ½"
  
  configurable_thresholds:
    description: "é–¾å€¤ã®å¤–éƒ¨è¨­å®šåŒ–"
    implementation:
      - "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®é–¾å€¤èª­ã¿è¾¼ã¿"
      - "ãƒ­ã‚°IDåˆ¥ã®å€‹åˆ¥é–¾å€¤è¨­å®š"
      - "å‹•çš„é–¾å€¤èª¿æ•´æ©Ÿèƒ½"
  
  multiple_metrics:
    description: "è¤‡æ•°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åŒæ™‚åˆ†æ"
    approach: "ãƒ¡ãƒˆãƒªã‚¯ã‚¹åˆ¥ã®å±¥æ­´ç®¡ç†ã¨ã‚¯ãƒ­ã‚¹åˆ†æ"

# ãƒ†ã‚¹ãƒˆæˆ¦ç•¥
testing_strategy:
  unit_tests:
    - "å„é–¢æ•°ã®æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆ"
    - "å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆï¼ˆ0æ—¥ã€1æ—¥ã€30æ—¥ã€31æ—¥ï¼‰"
    - "ãƒ‡ãƒ¼ã‚¿å½¢å¼å¤‰æ›ãƒ†ã‚¹ãƒˆ"
  
  integration_tests:
    - "å®Ÿéš›ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®å‹•ä½œç¢ºèª"
    - "é•·æœŸé–“ãƒ‡ãƒ¼ã‚¿ã§ã®æ€§èƒ½ãƒ†ã‚¹ãƒˆ"
    - "ãƒ•ã‚¡ã‚¤ãƒ«I/Oã‚¨ãƒ©ãƒ¼æ™‚ã®å‹•ä½œç¢ºèª"
  
  property_tests:
    - "å±¥æ­´ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®æ¤œè¨¼"
    - "å¢—åŠ ç‡è¨ˆç®—ã®æ­£ç¢ºæ€§æ¤œè¨¼"
    - "é€£ç¶šæ€¥å¢—æ¤œå‡ºã®ä¸€è²«æ€§æ¤œè¨¼"

# ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹è¨­è¨ˆ
resilience:
  circuit-breaker:
    considered: true
    decision: "not-adopted"
    rationale: |
      ãƒ­ã‚°å‚¾å‘åˆ†æã¯çŸ­æ™‚é–“ã§å®Œäº†ã™ã‚‹åˆ†æå‡¦ç†ã§ã‚ã‚Šã€
      ç¶™ç¶šçš„ãªæ¥ç¶šã‚„å¤§é‡ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æ‰±ã‚ãªã„ã€‚
      ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼ãŒå¿…è¦ã¨ãªã‚‹ã‚±ãƒ¼ã‚¹ã¯æƒ³å®šã•ã‚Œãªã„ã€‚
    implementation: []
  
  notification-throttling:
    considered: true
    decision: "delegated"
    rationale: |
      æ€¥å¢—æ¤œå‡ºæ™‚ã®é€šçŸ¥ã‚¹ãƒ‘ãƒ é˜²æ­¢ã¯ã€ä¸Šä½ã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
      ï¼ˆnotification.pyï¼‰ã§å®Ÿè£…ã™ã‚‹æ–¹ãŒè²¬å‹™ã®åˆ†é›¢ã¨ã—ã¦é©åˆ‡ã€‚
    delegated-to: "notification-system"
  
  baseline-reset:
    considered: true
    decision: "not-applicable"
    rationale: |
      ã“ã®æ©Ÿèƒ½ã¯baselineã‚’ä½¿ç”¨ã›ãšã€å‰æ—¥æ¯”ã§ã®ç›¸å¯¾çš„ãª
      å¤‰åŒ–ã‚’åˆ†æã™ã‚‹ãŸã‚ã€baselineè‡ªå‹•ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã¯ä¸è¦ã€‚
    implementation: []
  
  other-considerations:
    - consideration: "ãƒ‡ãƒ¼ã‚¿æ¬ ææ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯"
      decision: "adopted"
      rationale: |
        å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã§ã‚‚ã€åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ã§
        å¯èƒ½ãªç¯„å›²ã®åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ã€‚æœ€ä½1æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°
        ãƒ‡ãƒ¼ã‚¿è“„ç©çŠ¶æ³ã‚’å ±å‘Šã€‚
    - consideration: "ç•°å¸¸å€¤ã®é™¤å¤–"
      decision: "not-adopted"
      rationale: |
        v1.X.Xã§ã¯ç•°å¸¸å€¤ã®è‡ªå‹•é™¤å¤–ã¯å®Ÿè£…ã—ãªã„ã€‚
        ãƒ­ã‚°æ€¥å¢—ã¯é‡è¦ãªæƒ…å ±ã§ã‚ã‚Šã€è‡ªå‹•é™¤å¤–ã¯å±é™ºã€‚
        å°†æ¥ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§æ‰‹å‹•é™¤å¤–æ©Ÿèƒ½ã‚’æ¤œè¨ã€‚

# è¨­å®šä¾‹
configuration_examples:
  default_usage:
    description: "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§ã®ä½¿ç”¨"
    code: |
      result = analyze_log_trend("app.log")
      # "ğŸ“Š app.log: å‰æ—¥æ¯” +45.2% ã®æ€¥å¢—ã®å¯èƒ½æ€§"
  
  custom_threshold:
    description: "ã‚«ã‚¹ã‚¿ãƒ é–¾å€¤ã§ã®ä½¿ç”¨"
    code: |
      result = analyze_log_trend("app.log", threshold_percent=50)
      # ã‚ˆã‚Šé«˜ã„é–¾å€¤ã§æ€¥å¢—åˆ¤å®š
  
  spike_detection:
    description: "é€£ç¶šæ€¥å¢—ã®æ¤œå‡º"
    code: |
      is_spike = detect_repeated_spikes("app.log", days=3)
      # 3æ—¥é€£ç¶šã§ã®æ€¥å¢—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º