---
title: Komon テスト戦略
status: active
version: 1.11.0
created: 2025-11-21
updated: 2025-11-22
---

# Komon テスト戦略

## テスト方針

Komonは**実用性と保守性**を重視したテスト戦略を採用しています。

### 基本原則

1. **コアロジックを優先的にテスト**
   - リソース監視、閾値判定、ログ分析などの中核機能
   - 例外処理やエッジケースを含む

2. **外部依存は最小限にモック**
   - psutil、ファイルシステムなど
   - 実際の例外クラスを使用して現実的なテスト

3. **テストの目的は「実装の正しさの検証」**
   - テストをパスさせるためにテストを変更しない
   - 失敗したら実装を見直す

## テストカバレッジ目標

### 現状（v1.11.0）

- **総テスト数**: 111テスト（+18テスト）
- **カバー済みモジュール**: 9/9モジュール（100%）
- **コードカバレッジ**: 95%（331行中17行のみ未テスト）
- **品質スコア**: 95点（本番環境対応レベル）

### カバー済みモジュール

| モジュール | テスト数 | カバレッジ | 備考 |
|-----------|---------|-----------|------|
| `analyzer.py` | 10 | 100% | 閾値判定、アラート生成 |
| `log_analyzer.py` | 6 | 100% | ログ異常検知 |
| `monitor.py` | 7 | 100% | リソース監視、例外処理 |
| `history.py` | 9 | 89% | 履歴管理、ローテーション |
| `settings_validator.py` | 14 | 96% | 設定検証（網羅的） |
| `notification.py` | 9 | 100% | Slack/メール通知（モック使用） |
| `log_watcher.py` | 11 | 91% | ログファイル監視 |
| `log_trends.py` | 17 | 93% | ログ傾向分析 |
| `cli.py` | 10 | 96% | CLIエントリーポイント |

### 未カバー箇所（17行、5%）

主にエラーハンドリングの例外パスや、実行頻度の低いエッジケースです。
これらは実運用で発生する可能性が極めて低い箇所です。

## テストの種類

### ユニットテスト（現在の主力）

- 各モジュールの関数・クラスを個別にテスト
- 外部依存はモックで代替
- 高速実行（全テスト < 1秒）

### 統合テスト（今後追加予定）

- 複数モジュールの連携をテスト
- 実際のファイルシステムを使用
- CI/CDで実行

### エンドツーエンドテスト（将来的に検討）

- 実際のコマンド実行をテスト
- 本番環境に近い条件で実行

## テスト実行環境

### ローカル開発

```bash
# 全テスト実行
python -m pytest tests/ -v

# カバレッジ確認（推奨）
bash run_coverage.sh

# 特定モジュールのみ
python -m pytest tests/test_monitor.py -v
```

**注意**: CIFS/SMB共有環境では、`run_coverage.sh`を使用してください。
SQLiteロック問題を回避するため、カバレッジデータをローカルディスクに保存します。

### CI/CD（今後導入予定）

- GitHub Actions
- AlmaLinux 9コンテナで実行
- テスト結果をJUnit XMLで保存
- カバレッジレポートをアーティファクトとして保存

## テストの命名規則

### ファイル名
- `test_<モジュール名>.py`
- 例: `test_monitor.py`, `test_analyzer.py`

### クラス名
- `Test<機能名>`
- 例: `TestCollectResourceUsage`, `TestAnalyzeUsage`

### 関数名
- `test_<テストする内容>`
- 具体的で分かりやすい名前
- 例: `test_cpu_alert_when_above_threshold`

## テストデータ管理

### フィクスチャ（pytest fixtures）

- `conftest.py`で共通フィクスチャを定義
- 一時ディレクトリ: `tmp_path`
- モック設定: `@patch`デコレータ

### テストデータ

- ハードコードせず、フィクスチャで生成
- 実際のデータに近い値を使用
- エッジケース（0、負の値、境界値）を含む

## 例外処理のテスト

Komonでは例外処理が重要なため、以下を重点的にテスト：

1. **psutil例外**
   - `AccessDenied`: プロセス情報へのアクセス拒否
   - `NoSuchProcess`: プロセスが消えた場合

2. **ファイルシステム例外**
   - ファイルが存在しない
   - 権限エラー
   - ディスク容量不足

3. **設定ファイル例外**
   - YAML構文エラー
   - 必須項目の欠落
   - 不正な値

## テスト品質の維持

### レビュー基準

- [ ] テストが実装の正しさを検証している
- [ ] エッジケースを含む
- [ ] テスト名が内容を明確に表している
- [ ] モックが適切に設定されている
- [ ] テストが独立している（他のテストに依存しない）

### 継続的改善

- 新機能追加時は必ずテストも追加
- バグ修正時は再発防止のテストを追加
- カバレッジを定期的に確認
- テストの実行時間を監視（1秒以内を維持）

## 参考資料

- [tests/README.md](../../tests/README.md) - テスト実行ガイド
- [pytest公式ドキュメント](https://docs.pytest.org/)
- [pytest-cov](https://pytest-cov.readthedocs.io/)

## カバレッジ測定の改善（v1.10.1）

### 問題

CIFS/SMB共有環境でカバレッジ測定時にSQLiteロックエラーが発生：
```
sqlite3.OperationalError: database is locked
```

### 原因

- coverageツールは`.coverage`ファイルをSQLiteデータベースとして使用
- CIFS/SMBではファイルロック機構が不安定
- pytest-covとcoverage CLIの二重実行による競合

### 解決策

1. **カバレッジデータをローカルディスクに保存**
   - `.coveragerc`で`data_file`を`/home/kamodev/.coverage_devproject101`に設定
   - CIFS/SMBの不安定なロックを回避

2. **pytest-covとcoverage CLIの役割を分離**
   - `run_coverage.sh`でcoverage CLIのみを使用
   - pytest実行時は`--no-cov`オプションで競合を回避

3. **自動修正スクリプトの提供**
   - `setup_coverage_fix.sh`: 設定を自動生成
   - `check_coverage.py`: coverageツール不要の簡易チェック

## 更新履歴

- 2025-11-22: v1.11.0更新
  - プロパティベーステスト（hypothesis）を導入
  - 通知履歴機能のテスト18件を追加（111テスト）
  - 6つの正確性プロパティを検証
- 2025-11-22: v1.10.1更新
  - テストカバレッジ95%達成（47% → 95%）
  - 全9モジュールのテスト完了（93テスト）
  - CIFS/SMB環境でのカバレッジ測定問題を解決
  - カバレッジ測定ツール追加（run_coverage.sh等）

- 2025-11-21: 初版作成（v1.10.0）
  - 46テスト実装完了
  - コアモジュール5つをカバー
