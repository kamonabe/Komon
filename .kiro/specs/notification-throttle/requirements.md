---
title: 通知頻度制御（同一アラートの抑制）- 要件定義
feature: notification-throttle
status: draft
created: 2025-11-24
updated: 2025-11-24
---

# 通知頻度制御（同一アラートの抑制）- 要件定義

## 概要

同一のアラート（CPU/メモリ/ディスク超過）が短時間に繰り返し通知されることを防ぎ、
「通知疲れ」や「オオカミ少年化」を防止する機能。

## 用語集

- **通知頻度制御**: 同一アラートの通知間隔を制御する機能
- **通知抑制**: 設定された間隔内の重複通知を送信しないこと
- **閾値レベル**: 警告の深刻度（warning < alert < critical）
- **エスカレーション**: 長時間継続する問題の再通知
- **通知疲れ**: 頻繁な通知により重要な通知を見逃すこと
- **オオカミ少年化**: 繰り返される通知により信頼性が低下すること
- **throttle.json**: 通知履歴を保存するファイル（`data/notifications/throttle.json`）
- **メトリクスタイプ**: 監視対象の種類（cpu, memory, disk）

## 受入基準

### [AC-001] 通知抑制機能

**ユーザーストーリー:** システム管理者として、同じアラートが短時間に繰り返し通知されることを防ぎたいので、通知間隔を制御する機能が必要です。

#### 受入条件

1. **WHEN** 同一メトリクスタイプの通知が発生する場合、**THEN** 前回通知からの経過時間を確認しなければならない
2. **WHEN** 経過時間が設定された間隔（デフォルト60分）未満の場合、**THEN** 通知を抑制しなければならない
3. **WHEN** 通知が抑制された場合、**THEN** 抑制理由をログに記録しなければならない
4. **WHEN** 設定ファイルで間隔を変更した場合、**THEN** 新しい間隔が適用されなければならない
5. **WHEN** 初回通知の場合、**THEN** 抑制せずに送信しなければならない

### [AC-002] 閾値レベル変化時の即時通知

**ユーザーストーリー:** システム管理者として、状況が悪化した場合は即座に知りたいので、閾値レベルが上昇した場合は抑制を無視して通知する機能が必要です。

#### 受入条件

1. **WHEN** 前回通知時の閾値レベルを記録している場合、**THEN** 現在の閾値レベルと比較しなければならない
2. **WHEN** 閾値レベルが上昇した場合（warning→alert、alert→critical）、**THEN** 抑制間隔を無視して即座に通知しなければならない
3. **WHEN** 閾値レベルが同じまたは下がった場合、**THEN** 通常の抑制ルールを適用しなければならない
4. **WHEN** レベル上昇による通知の場合、**THEN** 通知理由を「level_up」として記録しなければならない
5. **WHEN** レベル上昇通知を送信した場合、**THEN** 新しいレベルを履歴に記録しなければならない

### [AC-003] エスカレーション機能

**ユーザーストーリー:** システム管理者として、長時間継続する問題を見逃さないために、定期的に再通知する機能が必要です。

#### 受入条件

1. **WHEN** 問題が初めて発生した場合、**THEN** 初回発生時刻を記録しなければならない
2. **WHEN** 前回通知から再通知間隔（デフォルト180分）が経過した場合、**THEN** エスカレーション通知を送信しなければならない
3. **WHEN** エスカレーション通知を送信する場合、**THEN** メッセージに継続時間を含めなければならない
4. **WHEN** 設定ファイルで再通知間隔を変更した場合、**THEN** 新しい間隔が適用されなければならない
5. **WHEN** 問題が解決した場合、**THEN** 初回発生時刻をリセットしなければならない

### [AC-004] 通知履歴の永続化

**ユーザーストーリー:** 開発者として、プロセス再起動後も抑制ロジックが機能するように、通知履歴を永続化する必要があります。

#### 受入条件

1. **WHEN** 通知を送信した場合、**THEN** 履歴を `data/notifications/throttle.json` に保存しなければならない
2. **WHEN** 履歴ファイルが存在しない場合、**THEN** 新規作成しなければならない
3. **WHEN** 履歴ファイルを読み込む場合、**THEN** JSON形式でパースしなければならない
4. **WHEN** 履歴ファイルが破損している場合、**THEN** エラーにせず新規作成しなければならない
5. **WHEN** プロセスを再起動した場合、**THEN** 保存された履歴を読み込んで抑制ロジックが継続しなければならない

### [AC-005] 設定ファイルでの制御

**ユーザーストーリー:** システム管理者として、環境に応じて通知頻度制御の動作を調整したいので、設定ファイルで制御できる必要があります。

#### 受入条件

1. **WHEN** `settings.yml` に `throttle.enabled` を設定した場合、**THEN** 有効/無効を切り替えられなければならない
2. **WHEN** `throttle.interval_minutes` を設定した場合、**THEN** 通知間隔が変更されなければならない
3. **WHEN** `throttle.escalation_minutes` を設定した場合、**THEN** 再通知間隔が変更されなければならない
4. **WHEN** 設定が不正な値（負の値、0等）の場合、**THEN** デフォルト値を使用しなければならない
5. **WHEN** 頻度制御を無効にした場合、**THEN** 全ての通知が抑制なしで送信されなければならない

### [AC-006] 既存機能との互換性

**ユーザーストーリー:** 開発者として、既存の通知機能に影響を与えずに頻度制御を追加したいので、後方互換性を保つ必要があります。

#### 受入条件

1. **WHEN** 頻度制御を導入した場合、**THEN** 既存の全テストがパスしなければならない
2. **WHEN** Slack通知を送信する場合、**THEN** 従来通り動作しなければならない
3. **WHEN** メール通知を送信する場合、**THEN** 従来通り動作しなければならない
4. **WHEN** 通知履歴機能と併用する場合、**THEN** 正しく記録されなければならない
5. **WHEN** 段階的閾値機能と併用する場合、**THEN** レベル上昇判定が正しく機能しなければならない

## 非機能要件

### パフォーマンス
- 通知判定処理は100ms以内に完了する
- 履歴ファイルのサイズは1MB以下に抑える（古いデータは自動削除）

### 信頼性
- ファイルI/Oエラーが発生しても通知は送信される
- 履歴ファイルが破損していても新規作成して継続動作する

### 保守性
- 抑制ロジックは独立したモジュールとして実装する
- テストカバレッジは95%以上を維持する

## 対象外

以下は今回の実装対象外とする:
- 通知チャネル（Slack/メール）ごとの個別制御
- ユーザーごとの通知設定
- 通知履歴のWeb UI表示

## 成功指標

- 通知頻度が適切に制御され、「通知疲れ」が軽減される
- 重要な通知（閾値レベル上昇）を見逃さない
- 長時間継続する問題が適切に再通知される
- 既存テストが全てパスする

## 参考資料

- TASK-002: ローカル通知履歴の保存と表示
- TASK-013: 段階的な閾値通知（警告→警戒→緊急）
- IDEA-016: 通知頻度制御（同一アラートの抑制）
