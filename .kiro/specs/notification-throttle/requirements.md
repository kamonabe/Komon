---
title: 通知頻度制御（同一アラートの抑制）- 要件定義
feature: notification-throttle
status: draft
created: 2025-11-24
updated: 2025-11-24
---

# 通知頻度制御（同一アラートの抑制）- 要件定義

## 概要

同一のアラート（CPU/メモリ/ディスク超過）が短時間に繰り返し通知されることを防ぎ、
「通知疲れ」や「オオカミ少年化」を防止する機能。

## 背景と課題

### 現状の問題
- cronが5分おきに実行され、閾値超過が続くと5分おきに通知が飛ぶ
- 同じ内容の通知が繰り返されると、ユーザーが見なくなる（オオカミ少年化）
- 重要な通知を見逃すリスクが高まる

### 解決したいこと
- 同一アラートの通知頻度を制御し、適切な間隔で通知する
- 状況が悪化した場合（閾値レベルが上がった場合）は即座に通知する
- 長時間継続する問題については、定期的に再通知する（エスカレーション）

## 要件

### R1: 通知抑制機能
**説明**: 同一メトリクスタイプ（CPU/メモリ/ディスク）の通知を、設定された間隔で抑制する

**詳細**:
- 前回通知からの経過時間を記録・確認する
- 設定された間隔（デフォルト: 60分）未満の場合、通知を抑制する
- 抑制された通知はログに記録する

**受け入れ基準**:
- 同一メトリクスの通知が60分以内に2回発生しない
- 抑制された通知がログに記録される
- 設定ファイルで間隔を変更できる

### R2: 閾値レベル変化時の即時通知
**説明**: 閾値レベルが上がった場合（警告→警戒、警戒→緊急）は、抑制を無視して即座に通知する

**詳細**:
- 前回通知時の閾値レベルを記録する
- 現在の閾値レベルと比較し、上昇している場合は即座に通知する
- 例: ディスク85%（警戒）→90%（緊急）の場合、60分経過していなくても通知

**受け入れ基準**:
- 閾値レベルが上がった場合、抑制間隔を無視して通知される
- 閾値レベルが同じまたは下がった場合は、通常の抑制ルールが適用される

### R3: エスカレーション機能
**説明**: 長時間継続する問題について、定期的に再通知する

**詳細**:
- 設定された再通知間隔（デフォルト: 180分 = 3時間）で再通知する
- 再通知メッセージには継続時間を含める
- 例: 「3時間経過しましたが、まだディスク使用率が高い状態が続いています（90%）」

**受け入れ基準**:
- 180分経過後に再通知される
- 再通知メッセージに継続時間が含まれる
- 設定ファイルで再通知間隔を変更できる

### R4: 通知履歴の永続化
**説明**: 通知履歴をファイルに保存し、プロセス再起動後も抑制ロジックが機能する

**詳細**:
- 通知履歴を `data/notifications/throttle.json` に保存する
- メトリクスタイプごとに最終通知時刻と閾値レベルを記録する
- ファイルが存在しない場合は新規作成する

**受け入れ基準**:
- 通知履歴がJSON形式で保存される
- プロセス再起動後も抑制ロジックが正しく機能する
- ファイルが破損している場合でもエラーにならない（新規作成）

### R5: 設定ファイルでの制御
**説明**: 通知頻度制御の動作を設定ファイルで調整できる

**詳細**:
- `settings.yml` に以下の設定を追加:
  - `throttle.enabled`: 有効/無効（デフォルト: true）
  - `throttle.interval_minutes`: 通知間隔（デフォルト: 60分）
  - `throttle.escalation_minutes`: 再通知間隔（デフォルト: 180分）
- 無効化した場合は、従来通りの動作（抑制なし）

**受け入れ基準**:
- 設定ファイルで有効/無効を切り替えられる
- 通知間隔と再通知間隔を変更できる
- 設定が不正な場合はデフォルト値を使用する

### R6: 既存機能との互換性
**説明**: 既存の通知機能に影響を与えない

**詳細**:
- Slack/メール通知は従来通り動作する
- 通知履歴機能（TASK-002）との共存
- 段階的閾値機能（TASK-013）との統合

**受け入れ基準**:
- 既存の全テストがパスする
- Slack/メール通知が正常に動作する
- 通知履歴に正しく記録される

## 非機能要件

### パフォーマンス
- 通知判定処理は100ms以内に完了する
- 履歴ファイルのサイズは1MB以下に抑える（古いデータは自動削除）

### 信頼性
- ファイルI/Oエラーが発生しても通知は送信される
- 履歴ファイルが破損していても新規作成して継続動作する

### 保守性
- 抑制ロジックは独立したモジュールとして実装する
- テストカバレッジは95%以上を維持する

## 対象外

以下は今回の実装対象外とする:
- 通知チャネル（Slack/メール）ごとの個別制御
- ユーザーごとの通知設定
- 通知履歴のWeb UI表示

## 成功指標

- 通知頻度が適切に制御され、「通知疲れ」が軽減される
- 重要な通知（閾値レベル上昇）を見逃さない
- 長時間継続する問題が適切に再通知される
- 既存テストが全てパスする

## 参考資料

- TASK-002: ローカル通知履歴の保存と表示
- TASK-013: 段階的な閾値通知（警告→警戒→緊急）
- IDEA-016: 通知頻度制御（同一アラートの抑制）
