# バージョン番号の決定ルール

## 基本方針

{{project.name}}プロジェクトは**Semantic Versioning 2.0.0**に従います。

バージョン番号は`MAJOR.MINOR.PATCH`の形式で表現されます。

参考: https://semver.org/

## Semantic Versioning (MAJOR.MINOR.PATCH)

### MAJOR (x.0.0) - 破壊的変更

**後方互換性のない変更**を含むリリース。

**該当する変更**:
- 設定ファイル形式の変更（手動移行が必要）
{% if project.type == "cli-tool" %}
- コマンドラインインターフェースの変更（既存スクリプトが動かなくなる）
{% endif %}
{% if project.type == "library" %}
- 公開APIの変更（既存コードが動かなくなる）
{% endif %}
- 既存機能の削除
{% if project.language == "python" %}
- Python最低バージョンの引き上げ（例: 3.10 → 3.11）
{% endif %}
{% if project.language == "node" %}
- Node.js最低バージョンの引き上げ
{% endif %}
- 依存パッケージのメジャーバージョンアップ（破壊的変更を含む）

**例**:
```
v1.16.0 → v2.0.0

### Breaking Changes
- 設定ファイル形式をYAMLからTOMLに変更
{% if project.type == "cli-tool" %}
- `{{project.name|lower}} monitor`コマンドの引数を変更（--interval → --check-interval）
{% endif %}
{% if project.language == "python" %}
- Python 3.9のサポートを終了（最低バージョン: {{environment.python_version}}）
{% endif %}
```

**注意**: MAJORバージョンアップは慎重に行い、移行ガイドを必ず提供します。

### MINOR (1.x.0) - 新機能追加

**後方互換性を保ちながら新機能を追加**するリリース。

**該当する変更**:
- 新しいモジュールの追加
{% if project.type == "cli-tool" %}
- 新しいコマンドの追加
{% endif %}
{% if project.type == "library" %}
- 新しい公開APIの追加
{% endif %}
- 既存機能の拡張（後方互換性あり）
- 新しいオプションの追加（既存の動作は変わらない）
- 新しい設定項目の追加（デフォルト値で従来通り動作）

**例**:
```
v1.16.0 → v1.17.0

### Added
- ログ傾向分析機能を追加
{% if project.type == "cli-tool" %}
- `{{project.name|lower}} trends`コマンドを追加
{% endif %}
- `--format json`オプションを追加（デフォルトはtext）
```

**注意**: 既存の動作が変わらないことを確認します。

### PATCH (1.16.x) - バグ修正・小改善

**後方互換性を保ちながらバグ修正や小さな改善**を行うリリース。

**該当する変更**:
- バグ修正
- パフォーマンス改善
- デフォルト値の変更（動作に影響が小さい）
- ドキュメント修正のみ
- 内部リファクタリング（ユーザーには見えない）
- 依存パッケージのパッチバージョンアップ

**例**:
```
v1.16.0 → v1.16.1

### Fixed
- 通知履歴の日時フォーマットエラーを修正
- メモリリークを修正

### Changed
- 通知履歴の表示件数をデフォルト10件に制限（--history 0で全件表示可能）
```

**注意**: 機能追加は含めません。

## 境界線のケース

以下のケースは判断が難しい場合があります。明確な基準を示します。

| 変更内容 | バージョン | 理由 |
|---------|-----------|------|
{% for case in versioning_boundary_cases %}
| {{case.change}} | **{{case.version}}** | {{case.reason}} |
{% endfor %}

## 複数の変更が混在する場合

**ルール**: 最も大きな変更に合わせる

### 例1: 新機能追加 + バグ修正

```
v1.16.0 → v1.17.0 (MINOR)

### Added
- ログ傾向分析機能を追加

### Fixed
- 通知履歴の日時フォーマットエラーを修正
```

**判断**: 新機能追加（MINOR）とバグ修正（PATCH）が含まれるため、最も大きな変更である**MINOR**を採用。

### 例2: バグ修正 + ドキュメント更新

```
v1.16.0 → v1.16.1 (PATCH)

### Fixed
- メモリリークを修正

### Changed
- README.mdの説明を改善
```

**判断**: バグ修正（PATCH）とドキュメント更新（PATCH）のため、**PATCH**を採用。

### 例3: 破壊的変更 + 新機能追加

```
v1.16.0 → v2.0.0 (MAJOR)

### Breaking Changes
- 設定ファイル形式をYAMLからTOMLに変更

### Added
- ログ傾向分析機能を追加
```

**判断**: 破壊的変更（MAJOR）と新機能追加（MINOR）が含まれるため、最も大きな変更である**MAJOR**を採用。

## 開発者向け改善の扱い

以下の変更は**バージョンアップしない**（`[Unreleased]`に記録）:

- Specテンプレートの追加
- CI/CDの導入
- 検証スクリプトの追加
- テストの追加のみ（機能追加を伴わない）
- 開発環境の改善（.gitignore, .editorconfig等）

**理由**: ユーザーの実行環境に影響しない

**リリースタイミング**:
- 次の機能追加やバグ修正と一緒にリリース
- または、開発者向け改善が溜まったら`MINOR`としてリリース

**例**:
```markdown
## [Unreleased]

### Developer Improvements
- Specテンプレートの追加
- GitHub Actions CI/CDの導入
- Spec検証スクリプトの追加

## [1.17.0] - 2025-11-26

### Added
- ログ傾向分析機能を追加

### Developer Improvements
（上記のUnreleasedから移動）
- Specテンプレートの追加
- GitHub Actions CI/CDの導入
- Spec検証スクリプトの追加
```

## Kiroの判断基準

Kiroが実装完了時にバージョン番号を提案する際の判断フロー：

### ステップ1: CHANGELOGの変更内容を確認

`{{changelog.location}}`の`[Unreleased]`セクションを確認します。

### ステップ2: 破壊的変更があるか？

以下のセクションまたはキーワードがあるか確認：
- `### Breaking Changes`
- `BREAKING CHANGE:`
- 設定ファイル形式の変更
{% if project.type == "cli-tool" %}
- コマンドラインインターフェースの変更
{% endif %}
{% if project.type == "library" %}
- 公開APIの変更
{% endif %}
- 既存機能の削除

**YES** → **MAJOR** (例: v2.0.0)

**NO** → 次へ

### ステップ3: 新機能追加があるか？

以下のセクションがあるか確認：
- `### Added`

**YES** → **MINOR** (例: v1.17.0)

**NO** → 次へ

### ステップ4: バグ修正や小改善があるか？

以下のセクションがあるか確認：
- `### Fixed`
- `### Changed`（小さな変更）

**YES** → **PATCH** (例: v1.16.2)

**NO** → 次へ

### ステップ5: 開発者向け改善のみか？

以下のセクションのみがあるか確認：
- `### Developer Improvements`

**YES** → **バージョンアップ不要**

ユーザーに「開発者向け改善のみなので、次の機能追加/バグ修正と一緒にリリースします」と報告。

### ステップ6: 複数の変更がある場合

最も大きな変更に合わせる：
- 破壊的変更 > 新機能追加 > バグ修正

## Kiroの提案メッセージ

### パターン1: MINOR（新機能追加）

```
✅ 実装が完了しました

【変更内容】
- 新機能: ログ傾向分析機能を追加
- バグ修正: 通知履歴の日時フォーマットエラーを修正
- テスト: プロパティテスト5件、ユニットテスト10件を追加

【テスト結果】
- 全243テストがパス
- カバレッジ: {{testing.coverage_target}}%

【バージョン提案】
v1.17.0 を提案します

理由: 新機能追加（MINOR）とバグ修正（PATCH）が含まれるため、
      最も大きな変更であるMINORを採用します。

次のステップ:
1. 内容を確認してください
2. バージョン番号を決定してください（v1.17.0でOKなら承認）
3. {{git.main_branch}}ブランチにマージしてタグを作成します
```

### パターン2: PATCH（バグ修正のみ）

```
✅ 実装が完了しました

【変更内容】
- バグ修正: メモリリークを修正
- ドキュメント: README.mdの説明を改善

【テスト結果】
- 全238テストがパス
- カバレッジ: {{testing.coverage_target}}%

【バージョン提案】
v1.16.2 を提案します

理由: バグ修正とドキュメント更新のみのため、PATCHを採用します。

次のステップ:
1. 内容を確認してください
2. バージョン番号を決定してください（v1.16.2でOKなら承認）
3. {{git.main_branch}}ブランチにマージしてタグを作成します
```

### パターン3: MAJOR（破壊的変更）

```
✅ 実装が完了しました

【変更内容】
- 破壊的変更: 設定ファイル形式をYAMLからTOMLに変更
- 新機能: ログ傾向分析機能を追加
- 移行ガイド: docs/MIGRATION.mdを追加

【テスト結果】
- 全250テストがパス
- カバレッジ: {{testing.coverage_target}}%

【バージョン提案】
v2.0.0 を提案します

理由: 破壊的変更（MAJOR）が含まれるため、MAJORを採用します。

⚠️ 注意: 既存ユーザーは手動で設定ファイルを移行する必要があります。
         docs/MIGRATION.mdに移行手順を記載しています。

次のステップ:
1. 内容を確認してください
2. 移行ガイドを確認してください
3. バージョン番号を決定してください（v2.0.0でOKなら承認）
4. {{git.main_branch}}ブランチにマージしてタグを作成します
```

### パターン4: バージョンアップ不要

```
✅ 実装が完了しました

【変更内容】
- 開発者向け改善: Specテンプレートを追加
- 開発者向け改善: CI/CDを導入
- 開発者向け改善: Spec検証スクリプトを追加

【判断】
開発者向け改善のみのため、バージョンアップは不要です。

CHANGELOGの[Unreleased]セクションに記録しました。
次の機能追加やバグ修正と一緒にリリースします。

次のステップ:
1. 内容を確認してください
2. {{git.main_branch}}ブランチにマージします（タグは作成しません）
```

## CHANGELOGの記載例

### MAJOR

```markdown
## [2.0.0] - 2025-11-26

### Breaking Changes

- **設定ファイル形式をYAMLからTOMLに変更**
  - `settings.yml` → `settings.toml`
  - 移行ガイド: `docs/MIGRATION.md`を参照
  - 既存の設定ファイルは手動で移行する必要があります

### Added

- ログ傾向分析機能を追加

### Migration Guide

既存ユーザーは以下の手順で移行してください：

1. `settings.yml`をバックアップ
2. `config/settings.toml.sample`をコピー
3. 設定値を移行（詳細は`docs/MIGRATION.md`を参照）
```

### MINOR

```markdown
## [1.17.0] - 2025-11-26

### Added

- **ログ傾向分析機能**
  - 過去7日間のログから異常なパターンを検出
{% if project.type == "cli-tool" %}
  - `{{project.name|lower}} trends`コマンドで実行
{% endif %}
  - 週次レポートにも自動的に含まれる

### Fixed

- 通知履歴の日時フォーマットエラーを修正

### Developer Improvements

- テストの追加: プロパティテスト5件、ユニットテスト10件
- カバレッジ{{testing.coverage_target}}%を維持
```

### PATCH

```markdown
## [1.16.2] - 2025-11-26

### Fixed

- メモリリークを修正（長時間実行時のメモリ使用量を50%削減）
- 通知履歴の日時フォーマットエラーを修正

### Changed

- README.mdの説明を改善
- エラーメッセージをより分かりやすく変更
```

## トラブルシューティング

### Q: 新機能追加だが、既存の動作が少し変わる場合は？

**A**: 以下の基準で判断してください：
- 既存スクリプトが動かなくなる → **MAJOR**
- 既存スクリプトは動くが、出力が変わる → **MINOR**（CHANGELOGに明記）
- 既存スクリプトも出力も変わらない → **MINOR**

### Q: バグ修正だが、動作が大きく変わる場合は？

**A**: 以下の基準で判断してください：
- 意図的な動作を変更 → **MINOR**または**MAJOR**
- バグを修正して正しい動作に戻す → **PATCH**

### Q: 複数のタスクを同時に実装した場合は？

**A**: 各タスクの変更内容を確認し、最も大きな変更に合わせます。

例：
- TASK-001（新機能） + TASK-002（バグ修正） → **MINOR**
- TASK-003（バグ修正） + TASK-004（バグ修正） → **PATCH**

### Q: ユーザーに確認が必要な場合は？

**A**: 以下の場合はユーザーに確認します：
- 境界線のケース（MINORかPATCHか迷う）
- 破壊的変更の可能性がある
- 複数のタスクで判断が難しい

## まとめ

- **MAJOR (x.0.0)**: 破壊的変更
- **MINOR (1.x.0)**: 新機能追加（後方互換性あり）
- **PATCH (1.16.x)**: バグ修正・小改善
- **複数の変更**: 最も大きな変更に合わせる
- **開発者向け改善**: バージョンアップしない（次のリリースに含める）
- **Kiroの判断**: CHANGELOGの内容から自動判断、境界線のケースはユーザーに確認

このルールにより、一貫性のあるバージョン管理が実現されます。
