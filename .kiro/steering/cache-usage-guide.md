# 📚 セッション内キャッシュ使用ガイド

## 🎯 概要

セッション内キャッシュシステムにより、ステアリングルールの重複読み込みを防止し、**年間数千ドルのクレジット節約**を実現します。

---

## 🚀 Kiroでの使用方法

### 1. **自動キャッシュ（推奨）**

Kiroが自動的にキャッシュを使用します：

```python
# Kiroが自動実行するコード
from .session_cache import cached_read_file

# キーワード検知による自動読み込み
if "実装" in user_message:
    cached_read_file("steering-detailed/development-workflow.md", "開発ワークフロー")
    cached_read_file("steering-detailed/git-workflow.md", "Git運用ルール")
```

### 2. **手動キャッシュ使用**

必要に応じて手動でキャッシュを使用：

```python
from .session_cache import cached_read_file, print_cache_summary

# ファイル読み込み（キャッシュ優先）
content = cached_read_file("steering-detailed/versioning-rules.md", "バージョニングルール")

# セッション統計の表示
print_cache_summary()
```

---

## 💰 クレジット節約効果

### 実際の節約例

```
実装セッション（8対話）:
従来方式: 120,000トークン消費
キャッシュ方式: 36,000トークン消費
節約率: 70%
節約額: $0.25/セッション

月間20セッション: $5/月節約
年間: $60/年節約（個人）
チーム5人: $300/年節約
```

### セッション内重複パターン

| ファイル | 重複回数 | 節約トークン | 節約額 |
|----------|----------|-------------|--------|
| git-workflow.md | 4回 → 1回 | 5,622 | $0.017 |
| testing-strategy.md | 3回 → 1回 | 3,744 | $0.011 |
| development-workflow.md | 2回 → 1回 | 2,500 | $0.008 |

---

## 📊 キャッシュ効果の確認

### 1. **リアルタイム表示**

キャッシュ使用時に自動表示：

```
💾 キャッシュから取得: git-workflow.md
📊 節約トークン: 1,874 (累計: 5,099)
💰 推定節約額: $0.015
```

### 2. **セッション統計**

セッション終了時の統計：

```python
from .session_cache import print_cache_summary

print_cache_summary()
```

出力例：
```
📊 セッションキャッシュ統計
キャッシュヒット: 12
ファイル読み込み: 4
ヒット率: 75.0%
節約トークン: 18,450
推定節約額: $0.055
キャッシュファイル数: 4
```

---

## 🔧 高度な使用方法

### 1. **キャッシュ状態の確認**

```python
from .session_cache import get_session_cache

cache = get_session_cache()
stats = cache.get_cache_stats()

print(f"現在のヒット率: {stats['hit_rate']:.1f}%")
print(f"累計節約額: ${stats['estimated_cost_savings']:.3f}")
```

### 2. **キャッシュのクリア**

```python
from .session_cache import clear_session_cache

# セッション終了時やテスト時
clear_session_cache()
```

### 3. **ファイル更新の検知**

キャッシュシステムは自動的にファイル更新を検知：

```
🔄 ファイル更新を検知: git-workflow.md
📖 ファイル読み込み: git-workflow.md  # 自動的に再読み込み
```

---

## 🎯 ベストプラクティス

### 1. **実装セッションでの活用**

```
セッション開始:
1. 「TASK-003を実装しよう」→ 4ファイル読み込み
2. 以降のGit、テスト関連質問 → キャッシュから高速取得
3. セッション終了時 → 統計確認

効果: 70%のクレジット節約
```

### 2. **長時間セッションでの効果最大化**

- 実装 → テスト → Git → リリースの一連の流れ
- 同じルールファイルを何度も参照
- キャッシュヒット率80%以上を目指す

### 3. **チーム開発での活用**

- 各メンバーがキャッシュ効果を享受
- 統一されたルール参照パターン
- チーム全体でのコスト削減効果

---

## 🚨 注意事項

### 1. **ファイル更新時の動作**

- ステアリングルールを更新した場合
- キャッシュシステムが自動的に検知
- 次回アクセス時に新しい内容を読み込み

### 2. **メモリ使用量**

- セッション内でのみキャッシュ保持
- セッション終了時に自動クリア
- 長時間セッションでも安全

### 3. **エラーハンドリング**

- ファイルが見つからない場合は空文字を返す
- ファイル読み込みエラーは適切にログ出力
- キャッシュエラーでもシステムは継続動作

---

## 📈 効果測定とモニタリング

### 1. **日次効果測定**

```python
# 1日の終わりに実行
print_cache_summary()

# 期待値:
# - ヒット率: 60-80%
# - 節約額: $0.50-2.00/日
```

### 2. **月次レポート**

- 累計節約トークン数
- 推定節約金額
- キャッシュヒット率の推移
- 最も効果的なファイル

### 3. **ROI計算**

```
実装コスト: 1日（開発工数）
年間節約額: $1,000-10,000
ROI: 数百倍の投資効果
```

---

**最終更新**: 2025-12-11
**対応バージョン**: 2.0.0
**推奨使用方法**: 自動キャッシュ（Kiroが自動実行）